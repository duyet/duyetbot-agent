bun test v1.3.3 (274e01c7)

packages/cloudflare-agent/src/__tests__/transport-manager.test.ts:
(pass) TransportManager > send > should send a message [3.19ms]
(pass) TransportManager > edit > should edit a message [0.17ms]
(pass) TransportManager > edit > should throw error if transport does not support editing [3.25ms]
(pass) TransportManager > delete > should delete a message [0.70ms]
(pass) TransportManager > delete > should throw error if transport does not support deletion [0.03ms]
(pass) TransportManager > typing > should send typing indicator [0.36ms]
(pass) TransportManager > typing > should throw error if transport does not support typing [0.08ms]
(pass) TransportManager > react > should add reaction to message [0.21ms]
(pass) TransportManager > react > should throw error if transport does not support reactions [0.59ms]
(pass) TransportManager > parseContext > should parse context to input [0.46ms]
(pass) TransportManager > capability checks > should report edit capability [0.04ms]
(pass) TransportManager > capability checks > should report delete capability [0.02ms]
(pass) TransportManager > capability checks > should report typing capability [0.03ms]
(pass) TransportManager > capability checks > should report react capability
(pass) TransportManager > getTransport > should return underlying transport [0.02ms]
(pass) TransportManager > startThinkingRotation > should start thinking rotation [203.85ms]
(pass) TransportManager > startThinkingRotation > should handle missing edit capability gracefully [203.49ms]
(pass) TransportManager > startThinking > should send initial thinking message and start rotation [203.85ms]
(pass) TransportManager > configuration > should use custom thinking messages [1.05ms]
(pass) TransportManager > configuration > should use custom rotation interval [0.24ms]

packages/cloudflare-agent/src/__tests__/format-history.test.ts:
(pass) formatHistoryAsXML > returns empty string for empty history [0.15ms]
(pass) formatHistoryAsXML > formats simple conversation history [6.02ms]
(pass) formatHistoryAsXML > filters out system and tool messages [2.68ms]
(pass) formatHistoryAsXML > escapes XML special characters [0.13ms]
(pass) formatHistoryAsXML > handles multiple exchanges [0.55ms]
(pass) formatHistoryAsXML > preserves message order [0.37ms]
(pass) formatWithEmbeddedHistory > returns system and user messages without history
(pass) formatWithEmbeddedHistory > embeds history in user message with XML tags [0.54ms]
(pass) formatWithEmbeddedHistory > wraps current message in XML tags when history exists [1.06ms]
(pass) formatWithEmbeddedHistory > does not wrap message when no history [0.07ms]
(pass) formatWithEmbeddedHistory > preserves system prompt exactly [0.01ms]
(pass) formatWithEmbeddedHistory > handles complex history with special characters [0.03ms]
(pass) formatWithEmbeddedHistory > returns only 2 messages regardless of history size [0.38ms]
(pass) formatWithEmbeddedHistory > with quoted context > includes quoted message XML when quotedContext provided [2.51ms]
(pass) formatWithEmbeddedHistory > with quoted context > uses default "a previous message" when username not provided [0.04ms]
(pass) formatWithEmbeddedHistory > with quoted context > does not include quoted message XML when quotedContext undefined [0.02ms]
(pass) formatWithEmbeddedHistory > with quoted context > escapes special characters in quoted text and username [0.95ms]
(pass) formatWithEmbeddedHistory > with quoted context > places quoted message before current message when history exists [0.11ms]
(pass) formatWithEmbeddedHistory > with quoted context > handles quoted context without history

packages/cloudflare-agent/src/__tests__/builtin-commands.test.ts:
(pass) built-in slash commands > /debug command formatting > formats /debug response correctly for MarkdownV2 mode (default) [0.11ms]
(pass) built-in slash commands > /debug command formatting > formats /debug response correctly for HTML mode [0.03ms]
(pass) built-in slash commands > /debug command formatting > parseMode HTML uses HTML tags
(pass) built-in slash commands > /debug command formatting > parseMode MarkdownV2 uses Markdown syntax [0.04ms]
(pass) built-in slash commands > /debug command formatting > parseMode undefined defaults to Markdown syntax
(pass) built-in slash commands > /debug command formatting > access denial response is consistent across modes [0.53ms]

packages/cloudflare-agent/src/__tests__/debug-footer-integration.test.ts:
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 1: CloudflareAgent.scheduleRouting succeeds > delegates to RouterAgent and returns immediately (non-blocking) [0.41ms]
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 1: CloudflareAgent.scheduleRouting succeeds > stores pending execution and schedules alarm [0.24ms]
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 1: CloudflareAgent.scheduleRouting succeeds > continues processing independently in RouterAgent.onExecutionAlarm [0.17ms]
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 1: CloudflareAgent.scheduleRouting succeeds > builds complete debug context with routing flow and classification [0.13ms]
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 1: CloudflareAgent.scheduleRouting succeeds > sends response with debug footer for admin user
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 1: CloudflareAgent.scheduleRouting succeeds > sends response without debug footer for non-admin user [0.19ms]
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 2: CloudflareAgent.scheduleRouting fails - fallback to direct chat > returns false when RouterAgent binding unavailable
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 2: CloudflareAgent.scheduleRouting fails - fallback to direct chat > returns false when scheduleExecution throws error
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 2: CloudflareAgent.scheduleRouting fails - fallback to direct chat > falls back to chat() with conversationHistory preserved
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 2: CloudflareAgent.scheduleRouting fails - fallback to direct chat > no debug context passed to sendPlatformResponse in fallback path
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 3: RouterAgent routing with complex query > builds routing flow with multiple agents (orchestrator delegation)
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 3: RouterAgent routing with complex query > includes worker status mapping in debug context [0.48ms]
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 3: RouterAgent routing with complex query > formats complex routing flow for admin debug footer [0.03ms]
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 4: Error handling and recovery > logs corrupted execution state and skips processing
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 4: Error handling and recovery > sends error message to user when execution fails [0.15ms]
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 4: Error handling and recovery > logs and handles sendPlatformResponse errors [0.31ms]
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 4: Error handling and recovery > cleans up pending execution even after error
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 5: Timing and performance > router classification measured separately from agent execution [0.13ms]
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 5: Timing and performance > deadline enforcement: 30s budget for RouterAgent.onExecutionAlarm
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 5: Timing and performance > tracks execution start and completion time [0.09ms]
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 6: Platform-specific response delivery > Telegram response with HTML parseMode and debug footer [0.06ms]
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 6: Platform-specific response delivery > GitHub response with Markdown debug footer [0.03ms]
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 6: Platform-specific response delivery > preserves message reference through entire flow [0.07ms]
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 7: State transitions and final cleanup > marks batch as delegated after successful scheduling [0.08ms]
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 7: State transitions and final cleanup > removes execution from pendingExecutions after completion [0.05ms]
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 7: State transitions and final cleanup > sets pendingExecutions to undefined when empty
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 7: State transitions and final cleanup > preserves other pending executions when removing one [0.07ms]
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 8: Debug metadata preservation > includes metadata from agent debug info
(pass) Debug Footer Integration - Complete Fire-and-Forget Flow > flow 8: Debug metadata preservation > includes token usage in routing flow steps

packages/cloudflare-agent/src/__tests__/memory-adapter.test.ts:
(pass) Memory Adapter > toMemoryMessage > should convert basic message
(pass) Memory Adapter > toMemoryMessage > should include tool metadata for tool messages
(pass) Memory Adapter > fromMemoryMessage > should convert basic memory message [0.04ms]
(pass) Memory Adapter > fromMemoryMessage > should restore tool metadata [0.16ms]
(pass) Memory Adapter > ChatAgent with MemoryAdapter > should create agent with memory adapter [0.22ms]
(pass) Memory Adapter > ChatAgent with MemoryAdapter > should auto-save messages after chat [0.85ms]
(pass) Memory Adapter > ChatAgent with MemoryAdapter > should not save when autoSave is false [0.20ms]
(pass) Memory Adapter > ChatAgent with MemoryAdapter > should load memory on first chat [0.12ms]
(pass) Memory Adapter > ChatAgent with MemoryAdapter > should allow manual save [0.11ms]
(pass) Memory Adapter > ChatAgent with MemoryAdapter > should update session ID

packages/cloudflare-agent/src/__tests__/debug-footer-fire-and-forget.test.ts:
(pass) Debug Footer Fire-and-Forget Flow > scheduleExecution behavior > returns scheduled: true when execution is successfully queued [0.27ms]
(pass) Debug Footer Fire-and-Forget Flow > scheduleExecution behavior > returns scheduled: false when context is invalid (empty query) [0.02ms]
(pass) Debug Footer Fire-and-Forget Flow > scheduleExecution behavior > returns scheduled: false when responseTarget is invalid (missing messageRef)
(pass) Debug Footer Fire-and-Forget Flow > scheduleExecution behavior > returns scheduled: false when messageId is missing from messageRef
(pass) Debug Footer Fire-and-Forget Flow > debug context construction in onExecutionAlarm > builds routing flow with router-agent and target agent [0.06ms]
(pass) Debug Footer Fire-and-Forget Flow > debug context construction in onExecutionAlarm > includes classification in debug context when present [0.02ms]
(pass) Debug Footer Fire-and-Forget Flow > debug context construction in onExecutionAlarm > omits classification when not present to satisfy exactOptionalPropertyTypes [0.04ms]
(pass) Debug Footer Fire-and-Forget Flow > debug context construction in onExecutionAlarm > includes tools in routing flow step when present [0.03ms]
(pass) Debug Footer Fire-and-Forget Flow > debug context construction in onExecutionAlarm > omits tools from routing flow step when empty
(pass) Debug Footer Fire-and-Forget Flow > debug context construction in onExecutionAlarm > includes sub-agents from orchestrator delegation
(pass) Debug Footer Fire-and-Forget Flow > debug context construction in onExecutionAlarm > includes workers with status mapping (success -> completed, failed -> error) [0.10ms]
(pass) Debug Footer Fire-and-Forget Flow > debug context construction in onExecutionAlarm > includes metadata from agent debug info [0.03ms]
(pass) Debug Footer Fire-and-Forget Flow > sendPlatformResponse with debug context > calls sendPlatformResponse with debugContext when admin user [0.08ms]
(pass) Debug Footer Fire-and-Forget Flow > sendPlatformResponse with debug context > omits debugContext when non-admin user
(pass) Debug Footer Fire-and-Forget Flow > sendPlatformResponse with debug context > handles @-prefixed username normalization [0.07ms]
(pass) Debug Footer Fire-and-Forget Flow > sendPlatformResponse with debug context > omits debugContext when adminUsername is missing [0.04ms]
(pass) Debug Footer Fire-and-Forget Flow > sendPlatformResponse with debug context > omits debugContext when username is missing [0.04ms]
(pass) Debug Footer Fire-and-Forget Flow > response text construction in onExecutionAlarm > builds successful response text from result content [0.09ms]
(pass) Debug Footer Fire-and-Forget Flow > response text construction in onExecutionAlarm > builds error response text when result fails [0.04ms]
(pass) Debug Footer Fire-and-Forget Flow > response text construction in onExecutionAlarm > builds error response with default message when error is undefined [0.01ms]
(pass) Debug Footer Fire-and-Forget Flow > execution context conversion > converts AgentContext to ExecutionContext with required fields [1.28ms]
(pass) Debug Footer Fire-and-Forget Flow > execution context conversion > uses default values for missing optional fields [0.10ms]
(pass) Debug Footer Fire-and-Forget Flow > routing flow timing calculations > calculates total duration from start time to completion
(pass) Debug Footer Fire-and-Forget Flow > routing flow timing calculations > separates router classification duration from target agent duration [0.03ms]
(pass) Debug Footer Fire-and-Forget Flow > routing flow timing calculations > handles case where routing history is empty [0.02ms]
(pass) Debug Footer Fire-and-Forget Flow > fallback behavior when scheduling fails > falls back to direct chat when scheduling returns false [0.01ms]
(pass) Debug Footer Fire-and-Forget Flow > fallback behavior when scheduling fails > continues with chat() when RouterAgent binding is unavailable
(pass) Debug Footer Fire-and-Forget Flow > fallback behavior when scheduling fails > logs error and returns false when scheduling throws
(pass) Debug Footer Fire-and-Forget Flow > platform-specific response handling > sends Telegram response when platform is telegram
(pass) Debug Footer Fire-and-Forget Flow > platform-specific response handling > sends GitHub response when platform is github
(pass) Debug Footer Fire-and-Forget Flow > platform-specific response handling > includes parseMode in Telegram response for debug footer formatting
(pass) Debug Footer Fire-and-Forget Flow > platform-specific response handling > defaults to HTML parseMode when not specified
(pass) Debug Footer Fire-and-Forget Flow > state management during fire-and-forget > stores pending execution in state before scheduling alarm [0.01ms]
(pass) Debug Footer Fire-and-Forget Flow > state management during fire-and-forget > removes execution from pending state after onExecutionAlarm completes
(pass) Debug Footer Fire-and-Forget Flow > state management during fire-and-forget > keeps other pending executions when removing one [0.04ms]
(pass) Debug Footer Fire-and-Forget Flow > state management during fire-and-forget > sets undefined when last execution is removed
(pass) Debug Footer Fire-and-Forget Flow > corruption handling in onExecutionAlarm > detects missing context field [0.04ms]
(pass) Debug Footer Fire-and-Forget Flow > corruption handling in onExecutionAlarm > detects missing query field
(pass) Debug Footer Fire-and-Forget Flow > corruption handling in onExecutionAlarm > detects missing responseTarget
(pass) Debug Footer Fire-and-Forget Flow > corruption handling in onExecutionAlarm > detects missing messageRef in responseTarget
(pass) Debug Footer Fire-and-Forget Flow > corruption handling in onExecutionAlarm > detects missing messageId in messageRef [0.05ms]
(pass) Debug Footer Fire-and-Forget Flow > corruption handling in onExecutionAlarm > cleans up corrupted execution and continues

packages/cloudflare-agent/src/__tests__/schedule-routing.test.ts:
(pass) scheduleRouting function signature > argument passing to RouterAgent.scheduleExecution > passes AgentContext as first argument [0.19ms]
(pass) scheduleRouting function signature > argument passing to RouterAgent.scheduleExecution > passes ScheduleRoutingTarget as second argument [0.23ms]
(pass) scheduleRouting function signature > argument passing to RouterAgent.scheduleExecution > calls scheduleExecution with exactly 2 arguments (not 3)
(pass) scheduleRouting function signature > AgentContext.query field population > preserves query from context passed to scheduleExecution
(pass) scheduleRouting function signature > AgentContext.query field population > maintains query field across different query types [0.17ms]
(pass) scheduleRouting function signature > AgentContext.query field population > requires non-empty query in context [0.06ms]
(pass) scheduleRouting function signature > AgentContext.query field population > query field is accessed from context parameter, not separate argument [0.09ms]
(pass) scheduleRouting function signature > context field preservation and propagation > preserves all AgentContext fields when passed to scheduleExecution [0.04ms]
(pass) scheduleRouting function signature > context field preservation and propagation > handles optional context fields correctly [0.10ms]
(pass) scheduleRouting function signature > context field preservation and propagation > includes platformConfig in context when provided [0.11ms]
(pass) scheduleRouting function signature > error handling and validation > scheduleExecution can validate required query field [0.12ms]
(pass) scheduleRouting function signature > error handling and validation > scheduleExecution can validate required messageRef field in target [0.15ms]
(pass) scheduleRouting function signature > error handling and validation > returns execution ID on successful scheduling [0.04ms]
(pass) scheduleRouting function signature > error handling and validation > returns empty executionId on failed scheduling [0.16ms]
(pass) scheduleRouting function signature > type safety verification > AgentContext parameter provides query field for scheduleExecution [0.33ms]
(pass) scheduleRouting function signature > type safety verification > ScheduleRoutingTarget parameter provides required fields
(pass) scheduleRouting function signature > type safety verification > scheduleExecution signature accepts exactly these parameter types [1.88ms]
(pass) scheduleRouting function signature > integration scenarios > processes a complete scheduling workflow [0.28ms]
(pass) scheduleRouting function signature > integration scenarios > handles multiple concurrent scheduling requests [0.54ms]

packages/cloudflare-agent/src/__tests__/orchestration.test.ts:

# Unhandled error between tests
-------------------------------
error: Cannot find module './batch-context-helpers.js' from '/Users/duet/project/duyetbot-agent/packages/cloudflare-agent/src/context/index.ts'
-------------------------------


packages/cloudflare-agent/src/__tests__/callbacks.test.ts:
(pass) Callback Parser > parseCallbackData > parses simple action without payload [0.18ms]
(pass) Callback Parser > parseCallbackData > parses action with payload [0.02ms]
(pass) Callback Parser > parseCallbackData > parses action with payload containing colons [0.03ms]
(pass) Callback Parser > parseCallbackData > returns null for invalid action [0.03ms]
(pass) Callback Parser > parseCallbackData > returns null for incomplete format (action with empty payload) [0.01ms]
(pass) Callback Parser > parseCallbackData > returns null for empty string
(pass) Callback Parser > parseCallbackData > returns null for whitespace-only string
(pass) Callback Parser > parseCallbackData > returns null for non-string input
(pass) Callback Parser > parseCallbackData > trims whitespace from input
(pass) Callback Parser > parseCallbackData > handles all valid HITL actions
(pass) Callback Parser > parseCallbackData > handles all valid message interaction actions
(pass) Callback Parser > serializeCallbackData > serializes action without payload [3.22ms]
(pass) Callback Parser > serializeCallbackData > serializes action with payload
(pass) Callback Parser > serializeCallbackData > throws error if total length exceeds 64 bytes [0.17ms]
(pass) Callback Parser > serializeCallbackData > handles UTF-8 multi-byte characters [0.02ms]
(pass) Callback Parser > serializeCallbackData > accepts payloads up to 64-byte limit [0.01ms]
(pass) Callback Parser > serializeCallbackData > roundtrips through parse
(pass) Callback Parser > isValidAction > returns true for valid action
(pass) Callback Parser > isValidAction > returns false for invalid action
(pass) Callback Parser > getCallbackDataSize > returns correct byte size for simple action
(pass) Callback Parser > getCallbackDataSize > returns correct byte size for action with payload
(pass) Callback Parser > getCallbackDataSize > handles multi-byte characters
(pass) Callback Handlers > Handler Map > has handler for each callback action
[Callbacks] HITL approve {"chatId":12345,"confirmationId":"confirm_123"}
(pass) Callback Handlers > hitl_approve handler > returns success result with message when payload provided [1.30ms]
[Callbacks] HITL approve {"chatId":12345}
(pass) Callback Handlers > hitl_approve handler > returns error when no payload provided [0.08ms]
[Callbacks] HITL reject {"chatId":12345,"confirmationId":"confirm_123"}
(pass) Callback Handlers > hitl_reject handler > returns success result with message when payload provided [0.07ms]
[Callbacks] HITL reject {"chatId":12345}
(pass) Callback Handlers > hitl_reject handler > returns error when no payload provided [0.11ms]
[Callbacks] HITL approve all {"chatId":12345}
(pass) Callback Handlers > hitl_approve_all handler > returns success and removes keyboard [0.09ms]
[Callbacks] HITL reject all {"chatId":12345}
(pass) Callback Handlers > hitl_reject_all handler > returns success and removes keyboard
[Callbacks] Regenerate response {"chatId":12345,"messageId":789}
(pass) Callback Handlers > regenerate handler > returns success message
[Callbacks] Expand response {"chatId":12345,"messageId":789}
(pass) Callback Handlers > expand handler > returns success message
[Callbacks] Simplify response {"chatId":12345,"messageId":789}
(pass) Callback Handlers > simplify handler > returns success message
[Callbacks] Positive feedback {"chatId":12345,"userId":999,"messageId":789}
(pass) Callback Handlers > feedback_up handler > returns success and removes keyboard
[Callbacks] Negative feedback {"chatId":12345,"userId":999,"messageId":789}
(pass) Callback Handlers > feedback_down handler > returns success and removes keyboard
[Callbacks] Positive feedback {"chatId":12345,"userId":999,"messageId":789}
(pass) Callback Handlers > Handler Error Handling > handlers are async functions
[Callbacks] HITL approve {"chatId":12345}
[Callbacks] HITL reject {"chatId":12345}
[Callbacks] HITL approve all {"chatId":12345}
[Callbacks] HITL reject all {"chatId":12345}
[Callbacks] Regenerate response {"chatId":12345,"messageId":789}
[Callbacks] Expand response {"chatId":12345,"messageId":789}
[Callbacks] Simplify response {"chatId":12345,"messageId":789}
[Callbacks] Positive feedback {"chatId":12345,"userId":999,"messageId":789}
[Callbacks] Negative feedback {"chatId":12345,"userId":999,"messageId":789}
(pass) Callback Handlers > Handler Error Handling > handlers return CallbackResult with success property [0.40ms]
[Callbacks] Positive feedback {"chatId":54321,"userId":777,"messageId":456}
(pass) Callback Integration > End-to-end callback processing > parses and routes feedback_up callback
[Callbacks] HITL approve {"chatId":54321,"confirmationId":"confirm_xyz"}
(pass) Callback Integration > End-to-end callback processing > parses and routes hitl_approve callback with payload
(pass) Callback Integration > End-to-end callback processing > handles invalid callback data gracefully
(pass) Callback Integration > End-to-end callback processing > validates all serialized callbacks are parseable
(pass) Callback Integration > Telegram Limits > enforces 64-byte limit for all callback data
(pass) Callback Integration > Telegram Limits > provides helpful error message for oversized data

packages/cloudflare-agent/src/__tests__/platform-integration.test.ts:
(pass) Feature Flags > parseFlagsFromEnv > should have debug disabled by default [0.02ms]
(pass) Feature Flags > parseFlagsFromEnv > should enable debug when ROUTER_DEBUG=true
(pass) Feature Flags > parseFlagsFromEnv > should enable debug when ROUTER_DEBUG=1
(pass) Feature Flags > parseFlagsFromEnv > should keep debug disabled for other values
(pass) RouterConfig Integration > should support telegram platform [0.03ms]
(pass) RouterConfig Integration > should support github platform
(pass) RouterConfig Integration > should support cli platform [0.02ms]
(pass) RouterConfig Integration > should support api platform [0.01ms]

packages/cloudflare-agent/src/__tests__/sanitize-telegram-response.test.ts:
(pass) sanitizeLLMResponseForTelegram > properly closed HTML anchor tags > should preserve properly closed anchor tags [1.69ms]
(pass) sanitizeLLMResponseForTelegram > properly closed HTML anchor tags > should handle multiple closed anchor tags [0.08ms]
(pass) sanitizeLLMResponseForTelegram > properly closed HTML anchor tags > should handle links with single quotes [0.01ms]
(pass) sanitizeLLMResponseForTelegram > unclosed anchor tags (the main fix) > should handle unclosed anchor tags at end of message [0.06ms]
(pass) sanitizeLLMResponseForTelegram > unclosed anchor tags (the main fix) > should handle unclosed anchor tags with URL used as text when no text provided [0.02ms]
(pass) sanitizeLLMResponseForTelegram > unclosed anchor tags (the main fix) > should handle unclosed anchor tags followed by newline
(pass) sanitizeLLMResponseForTelegram > unclosed anchor tags (the main fix) > should handle unclosed anchor tags followed by another HTML tag
(pass) sanitizeLLMResponseForTelegram > unclosed anchor tags (the main fix) > should handle unclosed anchor tags at message boundary
(pass) sanitizeLLMResponseForTelegram > unclosed anchor tags (the main fix) > should trim whitespace from unclosed link text
(pass) sanitizeLLMResponseForTelegram > unclosed anchor tags (the main fix) > should use URL as text when unclosed link has no text
(pass) sanitizeLLMResponseForTelegram > markdown links > should convert markdown links to HTML
(pass) sanitizeLLMResponseForTelegram > markdown links > should handle multiple markdown links
(pass) sanitizeLLMResponseForTelegram > mixed HTML and markdown formatting > should handle mixed closed and unclosed anchor tags
(pass) sanitizeLLMResponseForTelegram > mixed HTML and markdown formatting > should handle markdown and HTML links together
(pass) sanitizeLLMResponseForTelegram > HTML special characters > should escape ampersands in text
(pass) sanitizeLLMResponseForTelegram > HTML special characters > should escape angle brackets in text not in tags
(pass) sanitizeLLMResponseForTelegram > HTML special characters > should not double-escape existing entities [0.04ms]
(pass) sanitizeLLMResponseForTelegram > HTML special characters > should preserve URLs with special characters
(pass) sanitizeLLMResponseForTelegram > formatting tags > should convert bold markdown to HTML
(pass) sanitizeLLMResponseForTelegram > formatting tags > should convert italic markdown to HTML
(pass) sanitizeLLMResponseForTelegram > formatting tags > should convert inline code to HTML
(pass) sanitizeLLMResponseForTelegram > formatting tags > should handle code blocks
(pass) sanitizeLLMResponseForTelegram > formatting tags > should strip unsupported HTML tags [0.10ms]
(pass) sanitizeLLMResponseForTelegram > formatting tags > should convert <br> tags to newlines [0.01ms]
(pass) sanitizeLLMResponseForTelegram > complex real-world scenarios > should handle duyet.net CV links example [0.02ms]
(pass) sanitizeLLMResponseForTelegram > complex real-world scenarios > should handle mixed formatting with unclosed link
(pass) sanitizeLLMResponseForTelegram > complex real-world scenarios > should handle list with links [0.26ms]
(pass) sanitizeLLMResponseForTelegram > complex real-world scenarios > should clean up excessive whitespace [0.06ms]
(pass) sanitizeLLMResponseForTelegram > edge cases > should handle empty input
(pass) sanitizeLLMResponseForTelegram > edge cases > should handle whitespace-only input
(pass) sanitizeLLMResponseForTelegram > edge cases > should handle links with query parameters [0.01ms]
(pass) sanitizeLLMResponseForTelegram > edge cases > should handle links with encoded special characters [0.05ms]
(pass) sanitizeLLMResponseForTelegram > edge cases > should preserve text content exactly [0.01ms]
(pass) sanitizeLLMResponseForTelegram > edge cases > should handle consecutive unclosed links

packages/cloudflare-agent/src/__tests__/monitoring.test.ts:
(pass) Routing Monitoring > formatRoutingStats > formats basic stats correctly [0.21ms]
(pass) Routing Monitoring > formatRoutingStats > sorts targets by count descending [0.07ms]
(pass) Routing Monitoring > calculateEnhancedStats > calculates comprehensive statistics [0.20ms]
(pass) Routing Monitoring > calculateEnhancedStats > handles empty history
(pass) Routing Monitoring > calculateEnhancedStats > calculates p95 duration correctly [0.18ms]
(pass) Routing Monitoring > calculateAccuracyMetrics > calculates confidence metrics correctly [0.09ms]
(pass) Routing Monitoring > calculateAccuracyMetrics > categorizes confidence correctly
(pass) Routing Monitoring > calculateAccuracyMetrics > handles empty history
(pass) Routing Monitoring > exportRoutingHistoryJSON > exports valid JSON [0.92ms]
(pass) Routing Monitoring > exportRoutingHistoryJSON > includes all fields in JSON export [0.12ms]
(pass) Routing Monitoring > exportRoutingHistoryJSON > formats timestamps as ISO strings [0.15ms]
(pass) Routing Monitoring > exportRoutingHistoryCSV > exports valid CSV with headers [0.53ms]
(pass) Routing Monitoring > exportRoutingHistoryCSV > escapes quotes in CSV
(pass) Routing Monitoring > exportRoutingHistoryCSV > includes all columns in CSV export
(pass) Routing Monitoring > formatAccuracyMetrics > formats accuracy metrics correctly
(pass) Routing Monitoring > formatEnhancedStats > formats enhanced stats correctly
(pass) Routing Monitoring > formatEnhancedStats > includes time range when available [0.53ms]
(pass) Routing Monitoring > formatEnhancedStats > handles empty stats correctly [0.01ms]

packages/cloudflare-agent/src/__tests__/routing.test.ts:
[AgentRegistry] Agent registered {"name":"simple-agent","priority":10,"hasPatterns":true,"hasKeywords":true,"hasExcludePatterns":false}
[AgentRegistry] Agent registered {"name":"hitl-agent","priority":100,"hasPatterns":true,"hasKeywords":false,"hasExcludePatterns":false}
[AgentRegistry] Agent registered {"name":"orchestrator-agent","priority":40,"hasPatterns":true,"hasKeywords":false,"hasExcludePatterns":false}
[AgentRegistry] Agent registered {"name":"duyet-info-agent","priority":50,"hasPatterns":true,"hasKeywords":true,"hasExcludePatterns":false}
[AgentRegistry] Agent registered {"name":"lead-researcher-agent","priority":60,"hasPatterns":true,"hasKeywords":true,"hasExcludePatterns":false}
[RouterAgent/Classifier] System prompt loaded {"promptLength":4216,"promptPreview":"You are a query classifier for an AI agent system. Analyze user queries and classify them accurately.\n\n## CRITICAL: Tool Requirement Detection\n\nQueries requiring tools (NEVER answer from memory alone)..."}
[AgentRegistry] Quick match via pattern {"agent":"simple-agent","query":"hi"}
[Classifier] Quick classification via registry {"query":"hi","agentName":"simple-agent","category":"general","complexity":"low"}
(pass) quickClassify > greetings > classifies simple greetings [0.77ms]
[AgentRegistry] Quick match via pattern {"agent":"simple-agent","query":"Hello!"}
[Classifier] Quick classification via registry {"query":"Hello!","agentName":"simple-agent","category":"general","complexity":"low"}
(pass) quickClassify > greetings > classifies hello with punctuation
[AgentRegistry] Quick match via pattern {"agent":"simple-agent","query":"Good morning"}
[Classifier] Quick classification via registry {"query":"Good morning","agentName":"simple-agent","category":"general","complexity":"low"}
(pass) quickClassify > greetings > classifies good morning [0.09ms]
[AgentRegistry] Quick match via pattern {"agent":"simple-agent","query":"help"}
[Classifier] Quick classification via registry {"query":"help","agentName":"simple-agent","category":"general","complexity":"low"}
(pass) quickClassify > help commands > classifies help request
[AgentRegistry] Quick match via pattern {"agent":"simple-agent","query":"/help"}
[Classifier] Quick classification via registry {"query":"/help","agentName":"simple-agent","category":"general","complexity":"low"}
(pass) quickClassify > help commands > classifies /help command [0.10ms]
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"/clear"}
[Classifier] Quick classification via registry {"query":"/clear","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) quickClassify > admin commands > classifies clear command as needing approval [0.02ms]
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"reset"}
[Classifier] Quick classification via registry {"query":"reset","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) quickClassify > admin commands > classifies reset command as needing approval [0.04ms]
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"yes"}
[Classifier] Quick classification via registry {"query":"yes","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) quickClassify > tool confirmations > classifies yes as tool confirmation [0.03ms]
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"no"}
[Classifier] Quick classification via registry {"query":"no","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) quickClassify > tool confirmations > classifies no as tool confirmation
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"approve"}
[Classifier] Quick classification via registry {"query":"approve","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) quickClassify > tool confirmations > classifies approve as tool confirmation
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"reject"}
[Classifier] Quick classification via registry {"query":"reject","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) quickClassify > tool confirmations > classifies reject as tool confirmation
[AgentRegistry] Quick match via pattern {"agent":"lead-researcher-agent","query":"Can you review this PR for security issues?"}
[Classifier] Quick classification via registry {"query":"Can you review this PR for security issues?","agentName":"lead-researcher-agent","category":"research","complexity":"medium"}
(pass) quickClassify > complex queries > quick classifies PR review (matches research keyword)
(pass) quickClassify > complex queries > returns null for code-related queries without patterns
[AgentRegistry] Quick match via pattern {"agent":"lead-researcher-agent","query":"What are the best practices for React hooks?"}
[Classifier] Quick classification via registry {"query":"What are the best practices for React hooks?","agentName":"lead-researcher-agent","category":"research","complexity":"medium"}
(pass) quickClassify > complex queries > quick classifies research queries (matches best practices pattern) [0.02ms]
(pass) determineRouteTarget > routes tool_confirmation to hitl-agent [0.04ms]
(pass) determineRouteTarget > routes high complexity to orchestrator-agent
(pass) determineRouteTarget > routes queries requiring approval to hitl-agent
(pass) determineRouteTarget > routes simple general queries to simple-agent
(pass) determineRouteTarget > routes code queries to orchestrator-agent (which dispatches to CodeWorker)
(pass) determineRouteTarget > routes medium complexity research queries to lead-researcher-agent
(pass) determineRouteTarget > routes low complexity research queries to orchestrator-agent (which dispatches to ResearchWorker) [0.02ms]
(pass) determineRouteTarget > routes github queries to orchestrator-agent (which dispatches to GitHubWorker)
(pass) determineRouteTarget > routes general medium complexity to simple-agent

packages/cloudflare-agent/src/__tests__/debug-footer.test.ts:
(pass) escapeHtml > escapes ampersand
(pass) escapeHtml > escapes less than
(pass) escapeHtml > escapes greater than
(pass) escapeHtml > escapes double quotes
(pass) escapeHtml > escapes single quotes [0.02ms]
(pass) escapeHtml > escapes all special characters together
(pass) escapeHtml > returns empty string as is
(pass) escapeHtml > handles text with no special characters
(pass) formatDebugFooter > returns null when debugContext is undefined
(pass) formatDebugFooter > returns null when routingFlow is empty and no metadata [0.05ms]
(pass) formatDebugFooter > returns minimal footer when routingFlow is empty but has metadata [0.06ms]
(pass) formatDebugFooter > shortens model names correctly [0.02ms]
(pass) formatDebugFooter > formats basic routing flow [0.20ms]
(pass) formatDebugFooter > formats routing flow with per-step duration [0.06ms]
(pass) formatDebugFooter > formats routing flow with classification and timing [0.07ms]
(pass) formatDebugFooter > formats routing flow with error state [0.02ms]
(pass) formatDebugFooter > formats classification inline between router and target [0.04ms]
(pass) formatDebugFooter > displays last tool error with HTML escaping
(pass) formatDebugFooter > omits metadata line when no error message
(pass) formatDebugFooter > only shows error message from metadata [0.10ms]
(pass) formatDebugFooter > escapes HTML in error messages with special XML characters [0.02ms]
(pass) formatDebugFooter > returns properly formatted blockquote [0.03ms]
(pass) formatDebugFooter > handles complex real world scenario - success
(pass) formatDebugFooter > handles complex real world scenario - error with fallback [0.08ms]
(pass) formatDebugFooter > handles agent with only duration (no tools)
(pass) formatDebugFooter > handles agent with no duration
(pass) formatDebugFooter > handles error state without duration [0.05ms]
(pass) formatDebugFooter > formats nested workers for orchestrator [0.06ms]
(pass) formatDebugFooter > formats workers with running status
(pass) escapeMarkdownV2 > escapes all special characters
(pass) escapeMarkdownV2 > escapes backslash [0.04ms]
(pass) escapeMarkdownV2 > preserves plain text
(pass) smartEscapeMarkdownV2 > preserves bold formatting [0.12ms]
(pass) smartEscapeMarkdownV2 > preserves italic formatting [0.02ms]
(pass) smartEscapeMarkdownV2 > preserves plain links [0.05ms]
(pass) smartEscapeMarkdownV2 > preserves bold-wrapped links *[text](url)* [0.04ms]
(pass) smartEscapeMarkdownV2 > preserves italic-wrapped links _[text](url)_
(pass) smartEscapeMarkdownV2 > escapes special chars in plain text around formatted links [0.04ms]
(pass) smartEscapeMarkdownV2 > handles multiple bold links in text
(pass) smartEscapeMarkdownV2 > preserves inline code [0.04ms]
(pass) smartEscapeMarkdownV2 > preserves code blocks
(pass) smartEscapeMarkdownV2 > escapes parentheses in URLs [0.07ms]
(pass) smartEscapeMarkdownV2 > handles blog post list format [0.09ms]
(pass) formatDebugFooterMarkdown > returns null when debugContext is undefined [0.04ms]
(pass) formatDebugFooterMarkdown > returns null when routingFlow is empty [0.04ms]
(pass) formatDebugFooterMarkdown > formats basic routing flow with details wrapper [0.02ms]
(pass) formatDebugFooterMarkdown > formats routing flow with per-step duration
(pass) formatDebugFooterMarkdown > formats routing flow with classification and timing [0.04ms]
(pass) formatDebugFooterMarkdown > formats nested workers for orchestrator
(pass) formatDebugFooterMarkdown > formats workers with running status [0.09ms]
(pass) formatDebugFooterMarkdown > displays error metadata without HTML escaping
(pass) formatDebugFooterMarkdown > formats error state with duration
(pass) formatDebugFooterMarkdown > handles complex scenario with workers and error [0.10ms]
(pass) web search citations > shows web search enabled with no results [0.01ms]
(pass) web search citations > shows citations with truncated titles and domains [1.33ms]
(pass) web search citations > shows +N more indicator when more than 3 citations
(pass) web search citations > does not show web search line when not enabled [0.09ms]
(pass) web search citations > escapes special characters in HTML mode [0.01ms]
(pass) web search citations > shows web search in GitHub Markdown format

packages/cloudflare-agent/src/__tests__/duyet-info-agent.test.ts:
(pass) DuyetInfoAgent > duyetToolFilter > blog-related tools > should match blog tools
(pass) DuyetInfoAgent > duyetToolFilter > blog-related tools > should match article tools
(pass) DuyetInfoAgent > duyetToolFilter > blog-related tools > should match tag/category tools
(pass) DuyetInfoAgent > duyetToolFilter > blog-related tools > should match feed/rss tools
(pass) DuyetInfoAgent > duyetToolFilter > blog-related tools > should match content tools [0.02ms]
(pass) DuyetInfoAgent > duyetToolFilter > info-related tools > should match about tools [0.02ms]
(pass) DuyetInfoAgent > duyetToolFilter > info-related tools > should match CV/resume tools [0.02ms]
(pass) DuyetInfoAgent > duyetToolFilter > info-related tools > should match contact tools [0.01ms]
(pass) DuyetInfoAgent > duyetToolFilter > info-related tools > should match profile/bio tools [0.01ms]
(pass) DuyetInfoAgent > duyetToolFilter > info-related tools > should match experience/skill tools [0.02ms]
(pass) DuyetInfoAgent > duyetToolFilter > info-related tools > should match education/certificate tools
(pass) DuyetInfoAgent > duyetToolFilter > non-matching tools > should not match unrelated tools [0.04ms]
(pass) DuyetInfoAgent > duyetToolFilter > case insensitivity > should match regardless of case
[AgentRegistry] Quick match via pattern {"agent":"duyet-info-agent","query":"Who is Duyet?"}
[Classifier] Quick classification via registry {"query":"Who is Duyet?","agentName":"duyet-info-agent","category":"duyet","complexity":"low"}
(pass) DuyetInfoAgent > quickClassify for duyet queries > should classify queries about Duyet [0.07ms]
[AgentRegistry] Quick match via pattern {"agent":"duyet-info-agent","query":"Show me your CV"}
[Classifier] Quick classification via registry {"query":"Show me your CV","agentName":"duyet-info-agent","category":"duyet","complexity":"low"}
(pass) DuyetInfoAgent > quickClassify for duyet queries > should classify CV/resume queries [0.03ms]
[AgentRegistry] Quick match via pattern {"agent":"duyet-info-agent","query":"What's your experience?"}
[Classifier] Quick classification via registry {"query":"What's your experience?","agentName":"duyet-info-agent","category":"duyet","complexity":"low"}
(pass) DuyetInfoAgent > quickClassify for duyet queries > should classify about me queries [0.03ms]
[AgentRegistry] Quick match via pattern {"agent":"duyet-info-agent","query":"What are your skills?"}
[Classifier] Quick classification via registry {"query":"What are your skills?","agentName":"duyet-info-agent","category":"duyet","complexity":"low"}
(pass) DuyetInfoAgent > quickClassify for duyet queries > should classify skills queries [0.91ms]
[AgentRegistry] Quick match via pattern {"agent":"duyet-info-agent","query":"Tell me about your education"}
[Classifier] Quick classification via registry {"query":"Tell me about your education","agentName":"duyet-info-agent","category":"duyet","complexity":"low"}
(pass) DuyetInfoAgent > quickClassify for duyet queries > should classify education queries [0.16ms]
[AgentRegistry] Quick match via pattern {"agent":"duyet-info-agent","query":"What's on blog.duyet.net?"}
[Classifier] Quick classification via registry {"query":"What's on blog.duyet.net?","agentName":"duyet-info-agent","category":"duyet","complexity":"low"}
(pass) DuyetInfoAgent > quickClassify for duyet queries > should classify blog queries [0.12ms]
(pass) DuyetInfoAgent > quickClassify for duyet queries > should not classify unrelated queries [0.04ms]
(pass) DuyetInfoAgent > determineRouteTarget for duyet category > should route duyet category to duyet-info-agent
(pass) DuyetInfoAgent > determineRouteTarget for duyet category > should route high complexity duyet queries to duyet-info-agent

packages/cloudflare-agent/src/__tests__/hitl.test.ts:
(pass) HITL State Machine > createInitialHITLState > creates initial state with idle status
(pass) HITL State Machine > transitionHITLState > transitions to awaiting_confirmation on REQUEST_CONFIRMATION
(pass) HITL State Machine > transitionHITLState > transitions to executing on USER_APPROVED when no more pending
(pass) HITL State Machine > transitionHITLState > stays in awaiting_confirmation if more pending after approval
(pass) HITL State Machine > transitionHITLState > transitions to idle on USER_REJECTED
(pass) HITL State Machine > transitionHITLState > handles CONFIRMATION_EXPIRED
(pass) HITL State Machine > transitionHITLState > handles EXECUTION_COMPLETED
(pass) HITL State Machine > transitionHITLState > handles EXECUTION_FAILED
(pass) HITL State Machine > transitionHITLState > handles RESET
(pass) HITL State Machine > helper functions > isAwaitingConfirmation returns true when status is awaiting_confirmation
(pass) HITL State Machine > helper functions > getPendingConfirmations filters correctly
(pass) HITL State Machine > helper functions > getApprovedConfirmations filters correctly
(pass) HITL State Machine > helper functions > hasExpiredConfirmations detects expired
(pass) HITL State Machine > helper functions > getExpiredConfirmationIds returns expired IDs
(pass) HITL State Machine > helper functions > canTransitionTo validates transitions
(pass) HITL Confirmation > hasToolConfirmation > detects approval messages [0.66ms]
(pass) HITL Confirmation > hasToolConfirmation > detects rejection messages [0.07ms]
(pass) HITL Confirmation > hasToolConfirmation > returns false for non-confirmation messages
(pass) HITL Confirmation > parseConfirmationResponse > parses approval responses [0.11ms]
(pass) HITL Confirmation > parseConfirmationResponse > parses rejection responses
(pass) HITL Confirmation > parseConfirmationResponse > handles rejection without reason
(pass) HITL Confirmation > parseConfirmationResponse > parses specific confirmation ID [0.09ms]
(pass) HITL Confirmation > parseConfirmationResponse > returns none for non-confirmation
(pass) HITL Confirmation > determineRiskLevel > returns high for dangerous tools [0.07ms]
(pass) HITL Confirmation > determineRiskLevel > returns high for dangerous args [0.03ms]
(pass) HITL Confirmation > determineRiskLevel > returns medium for write operations
(pass) HITL Confirmation > determineRiskLevel > returns low for read operations [0.03ms]
(pass) HITL Confirmation > requiresConfirmation > returns true for high risk tools with high threshold
(pass) HITL Confirmation > requiresConfirmation > returns false for low risk tools with high threshold
(pass) HITL Confirmation > requiresConfirmation > returns true for medium risk with medium threshold
(pass) HITL Confirmation > createToolConfirmation > creates a valid confirmation [0.16ms]
(pass) HITL Confirmation > createToolConfirmation > uses custom expiry time
(pass) HITL Confirmation > formatConfirmationRequest > formats high risk confirmation
(pass) HITL Confirmation > formatConfirmationRequest > formats medium risk confirmation
(pass) HITL Confirmation > formatMultipleConfirmations > handles empty list
(pass) HITL Confirmation > formatMultipleConfirmations > formats single confirmation
(pass) HITL Confirmation > formatMultipleConfirmations > formats multiple confirmations
(pass) HITL Confirmation > isConfirmationValid > returns true for valid pending confirmation
(pass) HITL Confirmation > isConfirmationValid > returns false for expired confirmation
(pass) HITL Confirmation > isConfirmationValid > returns false for non-pending confirmation
(pass) HITL Confirmation > filterExpiredConfirmations > filters out expired pending confirmations
(pass) HITL Executions > executeTool > executes tool successfully [0.49ms]
(pass) HITL Executions > executeTool > handles tool failure [0.23ms]
(pass) HITL Executions > executeTool > handles timeout [102.93ms]
[HITLExecutor] Tool execution failed, retrying {"toolName":"bash","attempt":1,"maxRetries":3,"error":"Temporary failure"}
[HITLExecutor] Tool execution failed, retrying {"toolName":"bash","attempt":2,"maxRetries":3,"error":"Temporary failure"}
(pass) HITL Executions > executeTool > retries on failure [24.02ms]
[HITLExecutor] Executing tool {"toolName":"tool1","index":1,"total":2}
[HITLExecutor] Executing tool {"toolName":"tool2","index":2,"total":2}
(pass) HITL Executions > executeApprovedTools > executes multiple tools in sequence [1.70ms]
[HITLExecutor] Executing tool {"toolName":"tool1","index":1,"total":1}
(pass) HITL Executions > executeApprovedTools > filters non-approved confirmations [0.21ms]
[HITLExecutor] Executing tool {"toolName":"tool1","index":1,"total":2}
[HITLExecutor] Executing tool {"toolName":"tool2","index":2,"total":2}
(pass) HITL Executions > executeApprovedTools > continues on error by default [2.05ms]
[HITLExecutor] Executing tool {"toolName":"tool1","index":1,"total":2}
[HITLExecutor] Stopping batch execution due to error {"toolName":"tool1","error":"First fails"}
(pass) HITL Executions > executeApprovedTools > stops on error when configured [1.20ms]
[HITLExecutor] Executing tool {"toolName":"tool1","index":1,"total":1}
(pass) HITL Executions > executeApprovedTools > calls progress callback [0.98ms]
(pass) HITL Executions > executeToolsParallel > executes tools in parallel batches [23.38ms]
(pass) HITL Executions > formatExecutionResults > formats successful results [0.33ms]
(pass) HITL Executions > formatExecutionResults > formats mixed results [0.07ms]
(pass) HITL Executions > createMockExecutor > returns default success for unknown tools [11.52ms]
(pass) HITL Executions > createMockExecutor > returns configured results [10.84ms]
(pass) HITL Executions > createRegistryExecutor > executes registered tools [2.55ms]
(pass) HITL Executions > createRegistryExecutor > throws for unregistered tools [0.09ms]

packages/cloudflare-agent/src/__tests__/cloudflare-agent-smoke.test.ts:

# Unhandled error between tests
-------------------------------
error: Cannot find package 'cloudflare:email' from '/Users/duet/project/duyetbot-agent/node_modules/.bun/agents@0.2.28+4fb61e0291dc5e50/node_modules/agents/dist/src-DYN-ccro.js'
-------------------------------


packages/cloudflare-agent/src/__tests__/hitl-keyboard.test.ts:
(pass) HITL Keyboards - Validation > isValidCallbackData > accepts data under 64 bytes [0.05ms]
(pass) HITL Keyboards - Validation > isValidCallbackData > rejects data over 64 bytes [0.37ms]
(pass) HITL Keyboards - Validation > isValidCallbackData > accepts exactly 64 bytes [0.07ms]
(pass) HITL Keyboards - Validation > isValidCallbackData > counts multi-byte UTF-8 characters correctly [0.21ms]
(pass) HITL Keyboards - Validation > validateKeyboard > passes valid keyboards with no errors [0.09ms]
(pass) HITL Keyboards - Validation > validateKeyboard > detects callback_data exceeding 64 bytes
(pass) HITL Keyboards - Validation > validateKeyboard > ensures buttons have callback_data or url [0.17ms]
(pass) HITL Keyboards - Validation > validateKeyboard > prevents buttons from having both callback_data and url [0.02ms]
(pass) HITL Keyboards - Validation > validateKeyboard > validates entire keyboard structure [0.05ms]
(pass) HITL Keyboards - Confirmation > createConfirmationKeyboard > creates simple yes/no keyboard without ID
(pass) HITL Keyboards - Confirmation > createConfirmationKeyboard > includes confirmation ID in callback data [0.10ms]
(pass) HITL Keyboards - Confirmation > createConfirmationKeyboard > handles long IDs by truncating if needed [0.01ms]
(pass) HITL Keyboards - Confirmation > createConfirmationKeyboard > is fully compliant with Telegram API [0.02ms]
(pass) HITL Keyboards - Confirmation > createMultiConfirmationKeyboard > creates individual buttons for confirmations [0.06ms]
(pass) HITL Keyboards - Confirmation > createMultiConfirmationKeyboard > limits to 3 individual confirmations [0.51ms]
(pass) HITL Keyboards - Confirmation > createMultiConfirmationKeyboard > handles single confirmation [0.01ms]
(pass) HITL Keyboards - Confirmation > createMultiConfirmationKeyboard > handles empty confirmation array
(pass) HITL Keyboards - Confirmation > createMultiConfirmationKeyboard > uses truncated IDs in button text
(pass) HITL Keyboards - Confirmation > createMultiConfirmationKeyboard > maintains full IDs in callback data [0.08ms]
(pass) HITL Keyboards - Confirmation > createMultiConfirmationKeyboard > is fully compliant with Telegram API
(pass) HITL Keyboards - Feedback > createFeedbackKeyboard > creates thumbs up/down keyboard [0.07ms]
(pass) HITL Keyboards - Feedback > createFeedbackKeyboard > includes response ID in callback data
(pass) HITL Keyboards - Feedback > createFeedbackKeyboard > is fully compliant with Telegram API [0.04ms]
(pass) HITL Keyboards - Quick Actions > createQuickActionsKeyboard > creates three quick action buttons [0.03ms]
(pass) HITL Keyboards - Quick Actions > createQuickActionsKeyboard > has regenerate, expand, and simplify actions
(pass) HITL Keyboards - Quick Actions > createQuickActionsKeyboard > is fully compliant with Telegram API [0.07ms]
(pass) HITL - Confirmation Formatting with Keyboards > formatConfirmationWithKeyboard > returns both text and keyboard [0.07ms]
(pass) HITL - Confirmation Formatting with Keyboards > formatConfirmationWithKeyboard > text includes confirmation details
(pass) HITL - Confirmation Formatting with Keyboards > formatConfirmationWithKeyboard > keyboard matches confirmation ID
(pass) HITL - Confirmation Formatting with Keyboards > formatConfirmationWithKeyboard > keyboard is fully compliant [0.10ms]
(pass) HITL - Confirmation Formatting with Keyboards > formatMultipleConfirmationsWithKeyboard > returns both text and keyboard for multiple confirmations [0.03ms]
(pass) HITL - Confirmation Formatting with Keyboards > formatMultipleConfirmationsWithKeyboard > text indicates multiple confirmations needed
(pass) HITL - Confirmation Formatting with Keyboards > formatMultipleConfirmationsWithKeyboard > keyboard has individual and batch buttons
(pass) HITL - Confirmation Formatting with Keyboards > formatMultipleConfirmationsWithKeyboard > keyboard is fully compliant [0.11ms]
(pass) HITL Keyboards - Edge Cases > handles very long confirmation IDs gracefully [0.12ms]
(pass) HITL Keyboards - Edge Cases > handles special characters in confirmation IDs
(pass) HITL Keyboards - Edge Cases > handles many confirmations in multi-confirmation keyboard [0.07ms]
(pass) HITL Keyboards - Edge Cases > maintains consistency across formatter functions [0.12ms]

packages/cloudflare-agent/src/__tests__/classification-accuracy.test.ts:
[AgentRegistry] Quick match via pattern {"agent":"simple-agent","query":"hello"}
[Classifier] Quick classification via registry {"query":"hello","agentName":"simple-agent","category":"general","complexity":"low"}
(pass) Classification Accuracy Test Suite > Simple Queries  simple-agent > classifies greetings correctly [0.22ms]
(pass) Classification Accuracy Test Suite > Simple Queries  simple-agent > classifies hi there
[AgentRegistry] Quick match via pattern {"agent":"simple-agent","query":"good morning"}
[Classifier] Quick classification via registry {"query":"good morning","agentName":"simple-agent","category":"general","complexity":"low"}
(pass) Classification Accuracy Test Suite > Simple Queries  simple-agent > classifies good morning [0.24ms]
[AgentRegistry] Quick match via pattern {"agent":"simple-agent","query":"good afternoon"}
[Classifier] Quick classification via registry {"query":"good afternoon","agentName":"simple-agent","category":"general","complexity":"low"}
(pass) Classification Accuracy Test Suite > Simple Queries  simple-agent > classifies good afternoon [0.04ms]
[AgentRegistry] Quick match via pattern {"agent":"simple-agent","query":"good evening"}
[Classifier] Quick classification via registry {"query":"good evening","agentName":"simple-agent","category":"general","complexity":"low"}
(pass) Classification Accuracy Test Suite > Simple Queries  simple-agent > classifies good evening [0.02ms]
[AgentRegistry] Quick match via pattern {"agent":"simple-agent","query":"help"}
[Classifier] Quick classification via registry {"query":"help","agentName":"simple-agent","category":"general","complexity":"low"}
(pass) Classification Accuracy Test Suite > Simple Queries  simple-agent > classifies help request [0.01ms]
(pass) Classification Accuracy Test Suite > Simple Queries  simple-agent > classifies what can you do [0.02ms]
(pass) Classification Accuracy Test Suite > Simple Queries  simple-agent > classifies thanks [0.06ms]
(pass) Classification Accuracy Test Suite > Simple Queries  simple-agent > classifies goodbye [0.02ms]
(pass) Classification Accuracy Test Suite > Simple Queries  simple-agent > classifies simple question
(pass) Classification Accuracy Test Suite > Code Queries  orchestrator-agent (dispatches to CodeWorker) > classifies code review request
(pass) Classification Accuracy Test Suite > Code Queries  orchestrator-agent (dispatches to CodeWorker) > classifies bug fix request
[AgentRegistry] Quick match via pattern {"agent":"orchestrator-agent","query":"refactor the login function"}
[Classifier] Quick classification via registry {"query":"refactor the login function","agentName":"orchestrator-agent","category":"code","complexity":"high"}
(pass) Classification Accuracy Test Suite > Code Queries  orchestrator-agent (dispatches to CodeWorker) > classifies refactoring request
(pass) Classification Accuracy Test Suite > Code Queries  orchestrator-agent (dispatches to CodeWorker) > classifies TypeScript error explanation
(pass) Classification Accuracy Test Suite > Code Queries  orchestrator-agent (dispatches to CodeWorker) > classifies code generation request [0.10ms]
(pass) Classification Accuracy Test Suite > Code Queries  orchestrator-agent (dispatches to CodeWorker) > classifies debugging request
(pass) Classification Accuracy Test Suite > Code Queries  orchestrator-agent (dispatches to CodeWorker) > classifies optimization request [0.02ms]
(pass) Classification Accuracy Test Suite > Code Queries  orchestrator-agent (dispatches to CodeWorker) > classifies test writing request
(pass) Classification Accuracy Test Suite > Code Queries  orchestrator-agent (dispatches to CodeWorker) > classifies API implementation [0.03ms]
[AgentRegistry] Quick match via keyword {"agent":"lead-researcher-agent","query":"update React to latest version"}
[Classifier] Quick classification via registry {"query":"update React to latest version","agentName":"lead-researcher-agent","category":"research","complexity":"medium"}
(pass) Classification Accuracy Test Suite > Code Queries  orchestrator-agent (dispatches to CodeWorker) > classifies dependency update [0.02ms]
[AgentRegistry] Quick match via pattern {"agent":"lead-researcher-agent","query":"what are best practices for React hooks?"}
[Classifier] Quick classification via registry {"query":"what are best practices for React hooks?","agentName":"lead-researcher-agent","category":"research","complexity":"medium"}
(pass) Classification Accuracy Test Suite > Research Queries  lead-researcher-agent (medium/high) or orchestrator-agent (low) > classifies best practices research [0.01ms]
[AgentRegistry] Quick match via pattern {"agent":"lead-researcher-agent","query":"compare Redis vs Memcached"}
[Classifier] Quick classification via registry {"query":"compare Redis vs Memcached","agentName":"lead-researcher-agent","category":"research","complexity":"medium"}
(pass) Classification Accuracy Test Suite > Research Queries  lead-researcher-agent (medium/high) or orchestrator-agent (low) > classifies technology comparison
[AgentRegistry] Quick match via keyword {"agent":"lead-researcher-agent","query":"summarize the latest Next.js features"}
[Classifier] Quick classification via registry {"query":"summarize the latest Next.js features","agentName":"lead-researcher-agent","category":"research","complexity":"medium"}
(pass) Classification Accuracy Test Suite > Research Queries  lead-researcher-agent (medium/high) or orchestrator-agent (low) > classifies feature summary [0.05ms]
(pass) Classification Accuracy Test Suite > Research Queries  lead-researcher-agent (medium/high) or orchestrator-agent (low) > classifies documentation lookup [0.02ms]
(pass) Classification Accuracy Test Suite > Research Queries  lead-researcher-agent (medium/high) or orchestrator-agent (low) > classifies architecture research
(pass) Classification Accuracy Test Suite > Research Queries  lead-researcher-agent (medium/high) or orchestrator-agent (low) > classifies performance patterns
(pass) Classification Accuracy Test Suite > Research Queries  lead-researcher-agent (medium/high) or orchestrator-agent (low) > classifies security research
[AgentRegistry] Quick match via pattern {"agent":"lead-researcher-agent","query":"compare Webpack vs Vite for bundling"}
[Classifier] Quick classification via registry {"query":"compare Webpack vs Vite for bundling","agentName":"lead-researcher-agent","category":"research","complexity":"medium"}
(pass) Classification Accuracy Test Suite > Research Queries  lead-researcher-agent (medium/high) or orchestrator-agent (low) > classifies tool comparison [0.06ms]
(pass) Classification Accuracy Test Suite > Research Queries  lead-researcher-agent (medium/high) or orchestrator-agent (low) > classifies learning resource search
(pass) Classification Accuracy Test Suite > Research Queries  lead-researcher-agent (medium/high) or orchestrator-agent (low) > classifies technology trends [0.03ms]
(pass) Classification Accuracy Test Suite > GitHub Queries  orchestrator-agent (dispatches to GitHubWorker) > classifies PR creation [0.03ms]
(pass) Classification Accuracy Test Suite > GitHub Queries  orchestrator-agent (dispatches to GitHubWorker) > classifies CI status check
(pass) Classification Accuracy Test Suite > GitHub Queries  orchestrator-agent (dispatches to GitHubWorker) > classifies PR review
(pass) Classification Accuracy Test Suite > GitHub Queries  orchestrator-agent (dispatches to GitHubWorker) > classifies issue creation [0.03ms]
(pass) Classification Accuracy Test Suite > GitHub Queries  orchestrator-agent (dispatches to GitHubWorker) > classifies comment posting
(pass) Classification Accuracy Test Suite > GitHub Queries  orchestrator-agent (dispatches to GitHubWorker) > classifies PR merge
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"delete the feature branch"}
[Classifier] Quick classification via registry {"query":"delete the feature branch","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) Classification Accuracy Test Suite > GitHub Queries  orchestrator-agent (dispatches to GitHubWorker) > classifies branch management
(pass) Classification Accuracy Test Suite > GitHub Queries  orchestrator-agent (dispatches to GitHubWorker) > classifies release creation [0.01ms]
[AgentRegistry] Quick match via pattern {"agent":"lead-researcher-agent","query":"add review comment about line 45"}
[Classifier] Quick classification via registry {"query":"add review comment about line 45","agentName":"lead-researcher-agent","category":"research","complexity":"medium"}
(pass) Classification Accuracy Test Suite > GitHub Queries  orchestrator-agent (dispatches to GitHubWorker) > classifies code review comment [0.02ms]
(pass) Classification Accuracy Test Suite > GitHub Queries  orchestrator-agent (dispatches to GitHubWorker) > classifies PR status check
[AgentRegistry] Quick match via pattern {"agent":"orchestrator-agent","query":"refactor the entire authentication system"}
[Classifier] Quick classification via registry {"query":"refactor the entire authentication system","agentName":"orchestrator-agent","category":"code","complexity":"high"}
(pass) Classification Accuracy Test Suite > Complex/Orchestrator  orchestrator-agent > classifies system refactoring [0.10ms]
(pass) Classification Accuracy Test Suite > Complex/Orchestrator  orchestrator-agent > classifies CRUD implementation [0.05ms]
(pass) Classification Accuracy Test Suite > Complex/Orchestrator  orchestrator-agent > classifies architecture migration
(pass) Classification Accuracy Test Suite > Complex/Orchestrator  orchestrator-agent > classifies multi-component feature
(pass) Classification Accuracy Test Suite > Complex/Orchestrator  orchestrator-agent > classifies infrastructure setup
(pass) Classification Accuracy Test Suite > Complex/Orchestrator  orchestrator-agent > classifies large-scale refactoring [0.08ms]
(pass) Classification Accuracy Test Suite > Complex/Orchestrator  orchestrator-agent > classifies multi-service integration
(pass) Classification Accuracy Test Suite > Complex/Orchestrator  orchestrator-agent > classifies performance overhaul
(pass) Classification Accuracy Test Suite > Complex/Orchestrator  orchestrator-agent > classifies security audit and fixes [0.07ms]
(pass) Classification Accuracy Test Suite > Complex/Orchestrator  orchestrator-agent > classifies full feature implementation [0.02ms]
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"yes"}
[Classifier] Quick classification via registry {"query":"yes","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) Classification Accuracy Test Suite > HITL Queries  hitl-agent > classifies yes confirmation [0.03ms]
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"no"}
[Classifier] Quick classification via registry {"query":"no","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) Classification Accuracy Test Suite > HITL Queries  hitl-agent > classifies no rejection
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"approve"}
[Classifier] Quick classification via registry {"query":"approve","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) Classification Accuracy Test Suite > HITL Queries  hitl-agent > classifies approve [0.05ms]
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"reject"}
[Classifier] Quick classification via registry {"query":"reject","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) Classification Accuracy Test Suite > HITL Queries  hitl-agent > classifies reject [0.13ms]
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"confirm"}
[Classifier] Quick classification via registry {"query":"confirm","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) Classification Accuracy Test Suite > HITL Queries  hitl-agent > classifies confirm [0.01ms]
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"cancel"}
[Classifier] Quick classification via registry {"query":"cancel","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) Classification Accuracy Test Suite > HITL Queries  hitl-agent > classifies cancel [0.03ms]
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"/clear"}
[Classifier] Quick classification via registry {"query":"/clear","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) Classification Accuracy Test Suite > HITL Queries  hitl-agent > classifies clear command [0.10ms]
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"reset"}
[Classifier] Quick classification via registry {"query":"reset","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) Classification Accuracy Test Suite > HITL Queries  hitl-agent > classifies reset command [0.04ms]
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"delete all user data"}
[Classifier] Quick classification via registry {"query":"delete all user data","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) Classification Accuracy Test Suite > HITL Queries  hitl-agent > classifies destructive operation requiring approval
(pass) Classification Accuracy Test Suite > HITL Queries  hitl-agent > classifies sensitive modification
(pass) Classification Accuracy Test Suite > Edge Cases and Ambiguous Queries > handles empty query [0.05ms]
(pass) Classification Accuracy Test Suite > Edge Cases and Ambiguous Queries > handles whitespace-only query [0.02ms]
[AgentRegistry] Quick match via pattern {"agent":"simple-agent","query":"Hello!!!"}
[Classifier] Quick classification via registry {"query":"Hello!!!","agentName":"simple-agent","category":"general","complexity":"low"}
(pass) Classification Accuracy Test Suite > Edge Cases and Ambiguous Queries > handles punctuation-heavy greeting [0.04ms]
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"YES"}
[Classifier] Quick classification via registry {"query":"YES","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) Classification Accuracy Test Suite > Edge Cases and Ambiguous Queries > handles mixed case confirmations
(pass) Classification Accuracy Test Suite > Edge Cases and Ambiguous Queries > handles partial command match [0.05ms]
(pass) Classification Accuracy Test Suite > Edge Cases and Ambiguous Queries > routes admin command with extra text
[AgentRegistry] Quick match via pattern {"agent":"lead-researcher-agent","query":"review the code in PR #123 for security issues"}
[Classifier] Quick classification via registry {"query":"review the code in PR #123 for security issues","agentName":"lead-researcher-agent","category":"research","complexity":"medium"}
(pass) Classification Accuracy Test Suite > Edge Cases and Ambiguous Queries > handles code query with GitHub context
[AgentRegistry] Quick match via pattern {"agent":"lead-researcher-agent","query":"research best practices for implementing JWT authe"}
[Classifier] Quick classification via registry {"query":"research best practices for implementing JWT authe","agentName":"lead-researcher-agent","category":"research","complexity":"medium"}
(pass) Classification Accuracy Test Suite > Edge Cases and Ambiguous Queries > handles research with code context
[AgentRegistry] Quick match via pattern {"agent":"lead-researcher-agent","query":"research authentication patterns, implement OAuth,"}
[Classifier] Quick classification via registry {"query":"research authentication patterns, implement OAuth,","agentName":"lead-researcher-agent","category":"research","complexity":"medium"}
(pass) Classification Accuracy Test Suite > Edge Cases and Ambiguous Queries > handles multi-domain complex query
(pass) Classification Accuracy Test Suite > Routing Logic Priority Tests > prioritizes tool_confirmation over complexity
(pass) Classification Accuracy Test Suite > Routing Logic Priority Tests > prioritizes high complexity over category
(pass) Classification Accuracy Test Suite > Routing Logic Priority Tests > prioritizes requiresHumanApproval over category
(pass) Classification Accuracy Test Suite > Routing Logic Priority Tests > routes simple + low to simple-agent
(pass) Classification Accuracy Test Suite > Routing Logic Priority Tests > routes complex general to simple-agent
[AgentRegistry] Quick match via pattern {"agent":"simple-agent","query":"hello"}
[Classifier] Quick classification via registry {"query":"hello","agentName":"simple-agent","category":"general","complexity":"low"}
[AgentRegistry] Quick match via pattern {"agent":"simple-agent","query":"hi"}
[Classifier] Quick classification via registry {"query":"hi","agentName":"simple-agent","category":"general","complexity":"low"}
[AgentRegistry] Quick match via pattern {"agent":"simple-agent","query":"good morning"}
[Classifier] Quick classification via registry {"query":"good morning","agentName":"simple-agent","category":"general","complexity":"low"}
[AgentRegistry] Quick match via pattern {"agent":"simple-agent","query":"help"}
[Classifier] Quick classification via registry {"query":"help","agentName":"simple-agent","category":"general","complexity":"low"}
[AgentRegistry] Quick match via pattern {"agent":"simple-agent","query":"/help"}
[Classifier] Quick classification via registry {"query":"/help","agentName":"simple-agent","category":"general","complexity":"low"}
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"yes"}
[Classifier] Quick classification via registry {"query":"yes","agentName":"hitl-agent","category":"admin","complexity":"low"}
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"no"}
[Classifier] Quick classification via registry {"query":"no","agentName":"hitl-agent","category":"admin","complexity":"low"}
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"/clear"}
[Classifier] Quick classification via registry {"query":"/clear","agentName":"hitl-agent","category":"admin","complexity":"low"}
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"reset"}
[Classifier] Quick classification via registry {"query":"reset","agentName":"hitl-agent","category":"admin","complexity":"low"}
[AgentRegistry] Quick match via pattern {"agent":"hitl-agent","query":"approve"}
[Classifier] Quick classification via registry {"query":"approve","agentName":"hitl-agent","category":"admin","complexity":"low"}
(pass) Quick Classification Coverage > quick classifies 10 out of 140+ test queries
(pass) Quick Classification Coverage > requires LLM for queries without patterns
[AgentRegistry] Quick match via pattern {"agent":"lead-researcher-agent","query":"review this codebase thoroughly"}
[Classifier] Quick classification via registry {"query":"review this codebase thoroughly","agentName":"lead-researcher-agent","category":"research","complexity":"medium"}
[AgentRegistry] Quick match via pattern {"agent":"lead-researcher-agent","query":"best practices for React development"}
[Classifier] Quick classification via registry {"query":"best practices for React development","agentName":"lead-researcher-agent","category":"research","complexity":"medium"}
(pass) Quick Classification Coverage > quick classifies queries matching research patterns

packages/cloudflare-agent/src/agentic-loop/__tests__/agentic-loop.test.ts:
(pass) AgenticLoop > simple response (no tool calls) > should return response when LLM provides no tool calls [2.76ms]
(pass) AgenticLoop > simple response (no tool calls) > should track token usage [0.24ms]
(pass) AgenticLoop > tool execution > should execute tool and feed result back to LLM [12.10ms]
(pass) AgenticLoop > tool execution > should execute multiple tools in parallel [0.18ms]
(pass) AgenticLoop > tool execution > should handle tool not found gracefully
(pass) AgenticLoop > tool execution > should handle tool execution errors gracefully [0.35ms]
(pass) AgenticLoop > max iterations limit > should stop at max iterations [0.19ms]
(pass) AgenticLoop > progress callbacks > should call onProgress for thinking [3.12ms]
(pass) AgenticLoop > progress callbacks > should call onProgress for tool execution [0.63ms]
(pass) AgenticLoop > progress callbacks > should call onToolStart and onToolEnd callbacks [8.96ms]
(pass) AgenticLoop > progress callbacks > should not crash on progress callback error [1.00ms]
(pass) AgenticLoop > error handling > should handle LLM provider errors [0.81ms]
(pass) AgenticLoop > error handling > should handle missing provider [0.17ms]
(pass) AgenticLoop > message history > should build conversation history correctly [2.54ms]
(pass) AgenticLoop > message history > should expose message history via getMessages [0.17ms]
(pass) AgenticLoop > message history > should expose tools invoked via getToolsInvoked [0.11ms]
(pass) AgenticLoop > JSON argument parsing > should parse JSON arguments correctly [0.52ms]
(pass) AgenticLoop > JSON argument parsing > should handle invalid JSON arguments gracefully [0.05ms]
(pass) AgenticLoop > duration tracking > should track total duration [0.01ms]
(pass) AgenticLoop > createAgenticLoop factory > should create a configured loop instance

packages/cloudflare-agent/src/agentic-loop/__tests__/cloudflare-integration.test.ts:
(pass) runAgenticLoop > basic execution > should execute loop and return result [6.39ms]
(pass) runAgenticLoop > basic execution > should pass system prompt to loop [0.22ms]
(pass) runAgenticLoop > basic execution > should respect maxIterations configuration
(pass) runAgenticLoop > progress updates > should call transport.edit for progress updates [0.12ms]
(pass) runAgenticLoop > heartbeat integration > should call heartbeat function when provided
(pass) runAgenticLoop > typing indicator > should accept typing function [0.14ms]
(pass) runAgenticLoop > subagent mode > should exclude subagent tool when isSubagent=true [0.04ms]
(pass) runAgenticLoop > conversation history > should include conversation history in initial messages [0.01ms]
(pass) runAgenticLoop > error handling > should handle transport.edit errors gracefully
(pass) runAgenticLoop > metrics tracking > should include duration in metrics
(pass) runAgenticLoop > metrics tracking > should include token usage in metrics
(pass) formatAgenticLoopResponse > should return response without debug by default [0.58ms]
(pass) formatAgenticLoopResponse > should include debug footer when enabled [0.03ms]
(pass) formatAgenticLoopResponse > should handle singular iteration [0.01ms]
(pass) formatAgenticLoopResponse > should show "none" when no tools used
(pass) formatAgenticLoopResponse > should omit token info when not available [0.05ms]
(pass) formatAgenticLoopResponse > parseMode: HTML > should format debug footer as HTML code block
(pass) formatAgenticLoopResponse > parseMode: HTML > should not contain markdown formatting in HTML mode
(pass) formatAgenticLoopResponse > parseMode: HTML > should include emojis in HTML mode
(pass) formatAgenticLoopResponse > parseMode: MarkdownV2 > should format debug footer as MarkdownV2 code block [0.13ms]
(pass) formatAgenticLoopResponse > parseMode: MarkdownV2 > should escape special characters in MarkdownV2 [0.03ms]
(pass) formatAgenticLoopResponse > parseMode: MarkdownV2 > should include emojis in MarkdownV2 mode [0.02ms]
(pass) formatAgenticLoopResponse > parseMode: MarkdownV2 > should handle tools with special characters [0.64ms]
(pass) formatAgenticLoopResponse > parseMode: undefined (plaintext fallback) > should format debug footer as plaintext with separator [0.07ms]
(pass) formatAgenticLoopResponse > parseMode: undefined (plaintext fallback) > should include emojis in plaintext mode [0.09ms]
(pass) formatAgenticLoopResponse > parseMode: undefined (plaintext fallback) > should not contain code block markers [0.08ms]
(pass) shouldUseAgenticLoop > should return true for any query [0.05ms]

packages/cloudflare-agent/src/agentic-loop/__tests__/progress.test.ts:
(pass) PROGRESS_MESSAGES > thinking > should return thinking message with random rotator [0.18ms]
(pass) PROGRESS_MESSAGES > tool_start > should format tool start message
(pass) PROGRESS_MESSAGES > tool_complete > should format tool complete message with duration
(pass) PROGRESS_MESSAGES > tool_error > should format tool error message
(pass) PROGRESS_MESSAGES > tool_error > should truncate long error messages to 50 chars
(pass) PROGRESS_MESSAGES > responding > should return responding message [0.18ms]
(pass) ProgressTracker > constructor > should create tracker with default options [0.01ms]
(pass) ProgressTracker > constructor > should create tracker with custom maxDisplayedUpdates [0.27ms]
(pass) ProgressTracker > thinking > should record thinking step
(pass) ProgressTracker > thinking > should track multiple thinking steps [0.09ms]
(pass) ProgressTracker > toolStart > should record tool start [0.12ms]
(pass) ProgressTracker > toolComplete > should record successful tool completion [0.06ms]
(pass) ProgressTracker > toolComplete > should record failed tool execution
(pass) ProgressTracker > toolComplete > should handle missing error message [0.13ms]
(pass) ProgressTracker > responding > should record responding step [0.17ms]
(pass) ProgressTracker > format > should format updates as newline-separated messages [0.19ms]
(pass) ProgressTracker > format > should respect maxDisplayedUpdates limit [1.70ms]
(pass) ProgressTracker > format > should return empty string when no updates
(pass) ProgressTracker > getAll > should return copy of all updates
(pass) ProgressTracker > getSummary > should return summary statistics [0.24ms]
(pass) ProgressTracker > getSummary > should return zeros for empty tracker [0.02ms]
(pass) ProgressTracker > reset > should clear all updates [0.01ms]
(pass) ProgressTracker > onUpdate callback > should call onUpdate with formatted updates [0.11ms]
(pass) ProgressTracker > onUpdate callback > should call onUpdate with accumulated updates [0.28ms]
(pass) ProgressTracker > onUpdate callback > should handle async onUpdate callback [24.38ms]
(pass) createProgressTracker > should create tracker with edit callback [1.11ms]
(pass) createProgressTracker > should pass through options [0.16ms]
(pass) Integration: Full execution flow > should track complete agentic loop execution [0.15ms]
(pass) Integration: Full execution flow > should handle mixed success and failure [0.21ms]

packages/cloudflare-agent/src/agentic-loop/__tests__/tool-executor.test.ts:
(pass) ToolExecutor > register > should register a valid tool [0.44ms]
(pass) ToolExecutor > register > should throw on duplicate tool name [0.10ms]
(pass) ToolExecutor > register > should validate tool definition
(pass) ToolExecutor > register > should reject invalid tool names
(pass) ToolExecutor > registerAll > should register multiple tools
(pass) ToolExecutor > retrieval > should get tool by name [0.17ms]
(pass) ToolExecutor > retrieval > should return undefined for non-existent tool
(pass) ToolExecutor > retrieval > should check if tool exists [0.03ms]
(pass) ToolExecutor > retrieval > should get all tools
(pass) ToolExecutor > retrieval > should get tool names [0.06ms]
(pass) ToolExecutor > toAnthropicFormat > should convert tools to Anthropic format [0.10ms]
(pass) ToolExecutor > toAnthropicFormat > should handle tools without required fields [0.12ms]
(pass) ToolExecutor > execute > should execute a tool successfully [0.28ms]
(pass) ToolExecutor > execute > should return error for non-existent tool [0.45ms]
(pass) ToolExecutor > execute > should validate required arguments [0.10ms]
(pass) ToolExecutor > execute > should handle tool execution errors [0.12ms]
(pass) ToolExecutor > execute > should measure execution duration
(pass) ToolExecutor > executeAll > should execute multiple tools in parallel [0.21ms]
(pass) ToolExecutor > executeAll > should handle mixed success/failure [0.05ms]
(pass) ToolExecutor > createTool > should create a tool definition [0.02ms]

packages/cloudflare-agent/src/agentic-loop/__tests__/transport-adapter.test.ts:
(pass) createTransportAdapter > basic setup > should create adapter with callbacks and tracker
(pass) createTransportAdapter > onProgress callback > should handle thinking updates [0.40ms]
(pass) createTransportAdapter > onProgress callback > should handle tool_start updates [0.42ms]
(pass) createTransportAdapter > onProgress callback > should handle tool_complete updates [0.06ms]
(pass) createTransportAdapter > onProgress callback > should handle tool_error updates [0.07ms]
(pass) createTransportAdapter > onProgress callback > should handle responding updates
(pass) createTransportAdapter > heartbeat integration > should call heartbeat on progress updates [0.21ms]
(pass) createTransportAdapter > heartbeat integration > should not call heartbeat when disabled [0.05ms]
(pass) createTransportAdapter > heartbeat integration > should ignore heartbeat errors [0.12ms]
(pass) createTransportAdapter > typing indicator > should send typing indicator on progress
(pass) createTransportAdapter > typing indicator > should ignore typing errors [0.22ms]
(pass) createTransportAdapter > maxDisplayedUpdates configuration > should respect maxDisplayedUpdates limit [0.14ms]
(pass) createTransportAdapter > tracker access > should provide direct tracker access [0.05ms]
(pass) createTransportAdapter > tracker access > should provide summary statistics [0.04ms]
(pass) createSimpleProgressCallback > should create a simple callback that forwards messages [0.12ms]
(pass) formatProgressUpdate > should format thinking updates [0.08ms]
(pass) formatProgressUpdate > should format tool_start updates [0.08ms]
(pass) formatProgressUpdate > should format tool_complete updates with duration [0.02ms]
(pass) formatProgressUpdate > should format tool_complete updates without duration
(pass) formatProgressUpdate > should format tool_error updates
(pass) formatProgressUpdate > should format responding updates
(pass) formatProgressUpdate > should fall back to message for unknown types [0.08ms]

packages/cloudflare-agent/src/agents/__tests__/registry-exclude-patterns.test.ts:

# Unhandled error between tests
-------------------------------
-------------------------------


packages/cloudflare-agent/src/agents/__tests__/github-mcp-agent.test.ts:

# Unhandled error between tests
-------------------------------
-------------------------------


packages/cloudflare-agent/src/mcp-registry/__tests__/naming.test.ts:
(pass) MCP Tool Naming > formatMcpToolName > should format valid MCP and tool names [4.30ms]
(pass) MCP Tool Naming > formatMcpToolName > should handle names with numbers [0.05ms]
(pass) MCP Tool Naming > formatMcpToolName > should handle names with multiple underscores
(pass) MCP Tool Naming > formatMcpToolName > should throw on invalid MCP name [0.10ms]
(pass) MCP Tool Naming > formatMcpToolName > should throw on invalid tool name [0.07ms]
(pass) MCP Tool Naming > parseMcpToolName > should parse valid MCP tool names [0.11ms]
(pass) MCP Tool Naming > parseMcpToolName > should parse names with numbers [0.10ms]
(pass) MCP Tool Naming > parseMcpToolName > should parse names with multiple underscores [0.07ms]
(pass) MCP Tool Naming > parseMcpToolName > should return null for builtin tool names [3.05ms]
(pass) MCP Tool Naming > parseMcpToolName > should return null for invalid formats [0.40ms]
(pass) MCP Tool Naming > parseMcpToolName > should return null for uppercase names
(pass) MCP Tool Naming > parseMcpToolName > should return null for names with invalid characters [0.45ms]
(pass) MCP Tool Naming > parseMcpToolName > should return null for names starting with numbers
(pass) MCP Tool Naming > isMcpTool > should identify MCP tool names
(pass) MCP Tool Naming > isMcpTool > should identify builtin tool names
(pass) MCP Tool Naming > isMcpTool > should identify invalid names as non-MCP
(pass) MCP Tool Naming > isBuiltinTool > should identify builtin tool names
(pass) MCP Tool Naming > isBuiltinTool > should identify MCP tool names as non-builtin
(pass) MCP Tool Naming > isBuiltinTool > should complement isMcpTool correctly
(pass) MCP Tool Naming > isValidMcpName > should accept valid MCP names
(pass) MCP Tool Naming > isValidMcpName > should reject uppercase names
(pass) MCP Tool Naming > isValidMcpName > should reject names with invalid characters
(pass) MCP Tool Naming > isValidMcpName > should reject names starting with numbers
(pass) MCP Tool Naming > isValidMcpName > should reject empty names [0.03ms]
(pass) MCP Tool Naming > isValidMcpName > should reject names starting with underscore
(pass) MCP Tool Naming > isValidToolName > should accept valid tool names [0.72ms]
(pass) MCP Tool Naming > isValidToolName > should reject uppercase names [0.03ms]
(pass) MCP Tool Naming > isValidToolName > should reject names with invalid characters
(pass) MCP Tool Naming > isValidToolName > should reject names starting with numbers
(pass) MCP Tool Naming > isValidToolName > should reject empty names
(pass) MCP Tool Naming > isValidToolName > should reject names starting with underscore
(pass) MCP Tool Naming > isValidPrefixedMcpName > should accept valid prefixed names [0.16ms]
(pass) MCP Tool Naming > isValidPrefixedMcpName > should reject unprefixed names [0.07ms]
(pass) MCP Tool Naming > isValidPrefixedMcpName > should reject invalid formats [0.28ms]
(pass) MCP Tool Naming > isValidPrefixedMcpName > should reject uppercase names
(pass) MCP Tool Naming > round-trip conversion > should format and parse consistently

packages/cloudflare-agent/src/mcp-registry/__tests__/registry.test.ts:
(pass) MCPRegistry > creation > should create an empty registry [0.44ms]
(pass) MCPRegistry > creation > should create with initial servers [0.40ms]
(pass) MCPRegistry > creation > should create with factory function [0.05ms]
(pass) MCPRegistry > server registration > should register a server [0.09ms]
(pass) MCPRegistry > server registration > should register multiple servers [0.03ms]
(pass) MCPRegistry > server registration > should update an existing server [0.06ms]
(pass) MCPRegistry > server registration > should throw on invalid server name
(pass) MCPRegistry > server registration > should throw on missing display name
(pass) MCPRegistry > server registration > should throw on missing URL [4.08ms]
(pass) MCPRegistry > tool registration > should add a tool [0.11ms]
(pass) MCPRegistry > tool registration > should add multiple tools [0.07ms]
(pass) MCPRegistry > tool registration > should throw on duplicate tool name [1.16ms]
(pass) MCPRegistry > tool registration > should throw on invalid tool naming
(pass) MCPRegistry > tool registration > should add multiple tools at once
(pass) MCPRegistry > tool registration > should fail on first invalid tool when adding multiple
(pass) MCPRegistry > tool retrieval > should get a tool by name [0.28ms]
(pass) MCPRegistry > tool retrieval > should return undefined for non-existent tool [0.07ms]
(pass) MCPRegistry > tool retrieval > should list all tools [0.05ms]
(pass) MCPRegistry > tool retrieval > should get tools by MCP name [0.12ms]
(pass) MCPRegistry > tool retrieval > should return empty array for unknown MCP
(pass) MCPRegistry > tool retrieval > should check if tool exists
(pass) MCPRegistry > server listing > should list enabled servers only [0.14ms]
(pass) MCPRegistry > discovery tracking > should record a discovery result [0.08ms]
(pass) MCPRegistry > discovery tracking > should update discovery result [0.20ms]
(pass) MCPRegistry > discovery tracking > should get discovery status [0.04ms]
(pass) MCPRegistry > discovery tracking > should list discovery results
(pass) MCPRegistry > discovery tracking > should return undefined for undiscovered servers
(pass) MCPRegistry > tool clearing > should clear all tools [0.18ms]
(pass) MCPRegistry > tool clearing > should not clear servers when clearing tools
(pass) MCPRegistry > statistics > should provide registry statistics [0.05ms]
(pass) MCPRegistry > statistics > should return zero stats for empty registry [0.04ms]
(pass) MCPRegistry > initialization with options > should initialize with servers and options [0.11ms]

packages/cloudflare-agent/src/__tests__/auth/admin-checker.test.ts:
(pass) isAdminUser > should return false if config is missing [0.18ms]
(pass) isAdminUser > should return true for authorized user ID (string match)
(pass) isAdminUser > should return true for authorized user ID (number match)
(pass) isAdminUser > should return true for authorized user ID (string vs number match)
(pass) isAdminUser > should return true for authorized username [6.53ms]
(pass) isAdminUser > should return false for unauthorized user ID [0.14ms]
(pass) isAdminUser > should return false for unauthorized username [0.03ms]
(pass) isAdminUser > should return false if neither matches
(pass) isAdminUser > should return false if inputs are undefined

packages/cloudflare-agent/src/__tests__/mcp/mcp-initializer.test.ts:
(pass) MCPInitializer > should initialize servers [0.45ms]
(pass) MCPInitializer > should skip if already initialized [0.04ms]

packages/cloudflare-agent/src/__tests__/adapters/message-persistence.test.ts:
(pass) MessagePersistenceAdapter > should persist messages (smoke test) [0.63ms]
(pass) MessagePersistenceAdapter > should persist command [0.35ms]
(pass) MessagePersistenceAdapter > should load messages [0.13ms]
(pass) MessagePersistenceAdapter > should handle missing db gracefully

packages/cloudflare-agent/src/__tests__/workflow/formatting.test.ts:
(pass) Workflow Formatting > formatDuration > should format ms [0.09ms]
(pass) Workflow Formatting > formatDuration > should format seconds
(pass) Workflow Formatting > formatDuration > should format minutes [0.08ms]
(pass) Workflow Formatting > formatCompactNumber > should format small numbers [0.02ms]
(pass) Workflow Formatting > formatCompactNumber > should format k
(pass) Workflow Formatting > formatCostUsd > should format zero
(pass) Workflow Formatting > formatCostUsd > should format tiny cost
(pass) Workflow Formatting > formatCostUsd > should format small cost [0.07ms]
(pass) Workflow Formatting > formatCostUsd > should format larger cost [0.42ms]
(pass) Workflow Formatting > shortenModelName > should remove @preset/ [1.05ms]
(pass) Workflow Formatting > shortenModelName > should remove provider prefix [0.13ms]
(pass) Workflow Formatting > shortenModelName > should clean up claude names [0.06ms]
(pass) Workflow Formatting > formatToolArgs > should return empty string for no args [0.21ms]
(pass) Workflow Formatting > formatToolArgs > should prioritize keys
(pass) Workflow Formatting > formatToolArgs > should fallback to first key [0.17ms]
(pass) Workflow Formatting > formatToolArgs > should truncate long values [27.68ms]
(pass) Workflow Formatting > formatToolResponse > should truncate lines [0.07ms]
(pass) Workflow Formatting > formatToolResponse > should truncate length [0.10ms]

packages/cloudflare-agent/src/__tests__/workflow/step-tracker.test.ts:
(pass) StepProgressTracker > constructor > should create a tracker with default config [0.20ms]
(pass) StepProgressTracker > constructor > should accept custom config [0.03ms]
(pass) StepProgressTracker > addStep > should handle thinking step [0.47ms]
(pass) StepProgressTracker > addStep > should handle routing step [0.02ms]
(pass) StepProgressTracker > addStep > should handle tool_start step
(pass) StepProgressTracker > addStep > should handle tool_complete step
(pass) StepProgressTracker > addStep > should handle tool_error step
(pass) StepProgressTracker > addStep > should handle llm_iteration step
(pass) StepProgressTracker > addStep > should handle preparing step
(pass) StepProgressTracker > step accumulation > should accumulate completed steps
(pass) StepProgressTracker > step accumulation > should show current step with rotating suffix [0.37ms]
(pass) StepProgressTracker > rotation > should rotate suffix after interval [55.70ms]
(pass) StepProgressTracker > rotation > should stop rotation when destroyed [61.52ms]
(pass) StepProgressTracker > rotation > should stop rotation when step changes [59.65ms]
(pass) StepProgressTracker > execution path > should track full execution path [0.97ms]
(pass) StepProgressTracker > execution path > should format execution path as string [0.25ms]
(pass) StepProgressTracker > error handling > should not throw when update callback fails [0.65ms]
(pass) StepProgressTracker > error handling > should not update after destroyed [0.19ms]

packages/cloudflare-agent/src/__tests__/commands/builtin-commands.test.ts:
(pass) Built-in Commands > should handle /start [0.83ms]
(pass) Built-in Commands > should handle /help [0.08ms]
(pass) Built-in Commands > /debug > should deny access to non-admins [0.67ms]
(pass) Built-in Commands > /debug > should show info to admins (HTML) [0.76ms]
(pass) Built-in Commands > /debug > should show info to admins (Markdown) [0.10ms]
(pass) Built-in Commands > /clear > should reset state [0.16ms]
(pass) Built-in Commands > should return null for unknown commands

packages/cloudflare-agent/src/__tests__/routing/router-client.test.ts:

# Unhandled error between tests
-------------------------------
error: Cannot find module '../../routing/router-client.js' from '/Users/duet/project/duyetbot-agent/packages/cloudflare-agent/src/__tests__/routing/router-client.test.ts'
-------------------------------


packages/cloudflare-agent/src/__tests__/sanitization/telegram-sanitizer.test.ts:
(pass) Telegram Sanitization > should strip HTML tags [0.80ms]
(pass) Telegram Sanitization > should convert markdown bold to HTML
(pass) Telegram Sanitization > should convert markdown italic to HTML
(pass) Telegram Sanitization > should convert inline code [0.21ms]
(pass) Telegram Sanitization > should convert code blocks
(pass) Telegram Sanitization > should handle links [0.07ms]
(pass) Telegram Sanitization > should handle unclosed tags gracefully
(pass) Telegram Sanitization > should escape special characters [0.06ms]
(pass) Telegram Sanitization > should protect code from formatting [0.02ms]
(pass) Telegram Sanitization > should protect code blocks from formatting [0.02ms]

packages/cloudflare-agent/src/agentic-loop/tools/__tests__/github.test.ts:
(pass) GitHub Tool > tool definition > should have correct name
(pass) GitHub Tool > tool definition > should have descriptive description
(pass) GitHub Tool > tool definition > should have correct parameter structure
(pass) GitHub Tool > tool definition > should support all GitHub actions
(pass) GitHub Tool > tool execution > should execute list_prs action [0.74ms]
(pass) GitHub Tool > tool execution > should execute get_pr action with number
(pass) GitHub Tool > tool execution > should fail get_pr without number
(pass) GitHub Tool > tool execution > should execute list_issues action [0.02ms]
(pass) GitHub Tool > tool execution > should execute get_issue action with number [0.03ms]
(pass) GitHub Tool > tool execution > should fail get_issue without number [0.13ms]
(pass) GitHub Tool > tool execution > should execute get_repo action [0.07ms]
(pass) GitHub Tool > tool execution > should execute list_workflows action [0.03ms]
(pass) GitHub Tool > tool execution > should execute search action [0.03ms]
(pass) GitHub Tool > tool execution > should fail search without query [0.03ms]
(pass) GitHub Tool > tool execution > should fail with unknown action [0.03ms]
(pass) GitHub Tool > tool execution > should fail without action [0.02ms]
(pass) GitHub Tool > tool execution > should use default repo when not specified [0.14ms]
(pass) GitHub Tool > tool execution > should use custom default repo from config [0.07ms]
(pass) GitHub Tool > tool execution > should override default repo with provided repo [0.09ms]
(pass) GitHub Tool > tool factory > should create tool with custom timeout [0.03ms]
(pass) GitHub Tool > tool factory > should create tool with custom default repo [0.01ms]
(pass) GitHub Tool > tool factory > should create tool with all options
(pass) GitHub Tool > error handling > should handle execution gracefully [0.09ms]
(pass) GitHub Tool > error handling > should provide helpful error messages [0.05ms]

packages/cloudflare-agent/src/agentic-loop/tools/__tests__/research.test.ts:
(pass) researchTool > tool definition > should have correct name
(pass) researchTool > tool definition > should have a description
(pass) researchTool > tool definition > should have proper parameters schema
(pass) researchTool > tool definition > should have query parameter as required string
(pass) researchTool > tool definition > should have maxResults parameter as optional number
(pass) researchTool > tool definition > should have source parameter with enum [3.73ms]
(pass) researchTool > execute function > should return success for valid query [1.43ms]
(pass) researchTool > execute function > should handle different search sources [0.96ms]
(pass) researchTool > execute function > should respect maxResults parameter [0.26ms]
(pass) researchTool > execute function > should cap maxResults at 20 [0.02ms]
(pass) researchTool > execute function > should fail for empty query [0.06ms]
(pass) researchTool > execute function > should fail for invalid source [2.61ms]
(pass) researchTool > execute function > should include data in stub response
(pass) researchTool > execute function > should indicate this is a stub response
(pass) researchTool > SearchResult type > should be exported for use in search implementations

packages/cloudflare-agent/src/agentic-loop/tools/__tests__/duyet-mcp.test.ts:

# Unhandled error between tests
-------------------------------
21 |   inferMcpToolFromQuery,
22 | } from '../duyet-mcp.js';
23 | 
24 | // Mock fetch for MCP server calls
25 | const mockFetch = vi.fn();
26 | vi.stubGlobal('fetch', mockFetch);
        ^
TypeError: vi.stubGlobal is not a function. (In 'vi.stubGlobal("fetch", mockFetch)', 'vi.stubGlobal' is undefined)
      at /Users/duet/project/duyetbot-agent/packages/cloudflare-agent/src/agentic-loop/tools/__tests__/duyet-mcp.test.ts:26:4
      at loadAndEvaluateModule (2:1)
-------------------------------


packages/cloudflare-agent/src/agentic-loop/tools/__tests__/plan.test.ts:
(pass) Plan Tool > Tool Definition > should have correct name [0.08ms]
(pass) Plan Tool > Tool Definition > should have descriptive description [0.03ms]
(pass) Plan Tool > Tool Definition > should have required parameters [0.02ms]
(pass) Plan Tool > Tool Definition > should define task and context properties [0.02ms]
(pass) Plan Tool > Tool Definition > should have execute function [0.03ms]
(pass) Plan Tool > Basic Planning > should successfully plan a simple task [0.68ms]
(pass) Plan Tool > Basic Planning > should plan a task with context [4.60ms]
(pass) Plan Tool > Basic Planning > should include planning prompt in output [0.19ms]
(pass) Plan Tool > Error Handling > should reject empty task [0.10ms]
(pass) Plan Tool > Error Handling > should reject null task [0.10ms]
(pass) Plan Tool > Error Handling > should reject whitespace-only task [0.03ms]
(pass) Plan Tool > Error Handling > should handle missing task gracefully [0.04ms]
(pass) Plan Tool > Response Structure > should include iteration info in output [0.04ms]
(pass) Plan Tool > Response Structure > should include tool history in output when available [0.44ms]
(pass) Plan Tool > Response Structure > should not include tool history when empty [0.45ms]
(pass) Plan Tool > Response Structure > should include context info in output when provided [0.13ms]
(pass) Plan Tool > Response Structure > should not include context info when not provided [0.26ms]
(pass) Plan Tool > Data Structure > should return structured data on success [0.13ms]
(pass) Plan Tool > Data Structure > should include accurate task in data [0.14ms]
(pass) Plan Tool > Data Structure > should include tool history map in data [0.07ms]
(pass) Plan Tool > Performance > should complete quickly for simple tasks
(pass) Plan Tool > Performance > should complete quickly even with large context [0.15ms]
(pass) Plan Tool > Performance > should measure duration accurately [0.33ms]
(pass) Plan Tool > Subagent Context > should handle subagent execution [0.22ms]
(pass) Plan Tool > Factory Function > should create plan tool via factory [0.30ms]
(pass) Plan Tool > Logging > should log plan invocation [0.07ms]
(pass) Plan Tool > Logging > should log errors
(pass) Plan Tool > Complex Scenarios > should plan multi-stage architecture task [0.13ms]
(pass) Plan Tool > Complex Scenarios > should plan with accumulated tool history [0.15ms]
(pass) Plan Tool > Long Form Tasks > should handle very long task descriptions [0.14ms]
(pass) Plan Tool > Long Form Tasks > should handle very long context

packages/cloudflare-agent/src/agentic-loop/tools/__tests__/subagent.test.ts:
(pass) subagentTool > Tool Definition > has correct name and description [0.39ms]
(pass) subagentTool > Tool Definition > requires task parameter [0.04ms]
(pass) subagentTool > Tool Definition > has task and context properties [0.03ms]
(pass) subagentTool > Recursion Prevention (CRITICAL) > rejects subagent spawning from parent loop [0.54ms]
(pass) subagentTool > Recursion Prevention (CRITICAL) > prevents subagent from spawning another subagent [0.06ms]
(pass) subagentTool > Recursion Prevention (CRITICAL) > returns appropriate error message for recursive spawn [0.24ms]
(pass) subagentTool > Task Delegation > accepts task and context arguments [0.04ms]
(pass) subagentTool > Task Delegation > handles task without context [0.03ms]
(pass) subagentTool > Task Delegation > includes stub implementation note
(pass) subagentTool > Performance Tracking > includes execution duration
(pass) subagentTool > Performance Tracking > measures execution time accurately [0.08ms]
(pass) subagentTool > Error Handling > always returns a valid ToolResult [0.06ms]
(pass) subagentTool > Error Handling > populates error field only on failure

packages/cloudflare-agent/src/agentic-loop/tools/__tests__/memory.test.ts:
(pass) Memory Tools > memorySaveTool > tool metadata > should have correct name [0.04ms]
(pass) Memory Tools > memorySaveTool > tool metadata > should have description [0.02ms]
(pass) Memory Tools > memorySaveTool > tool metadata > should have valid parameters schema [0.02ms]
(pass) Memory Tools > memorySaveTool > tool metadata > should define memory type enum values [0.02ms]
(pass) Memory Tools > memorySaveTool > tool metadata > should define category enum values [0.01ms]
(pass) Memory Tools > memorySaveTool > execute with short-term memory > should save short-term memory successfully [376.48ms]
(pass) Memory Tools > memorySaveTool > execute with long-term memory > should save long-term memory successfully [46.50ms]
(pass) Memory Tools > memorySaveTool > execute with long-term memory > should handle missing category for long-term memory [50.28ms]
(pass) Memory Tools > memorySaveTool > execution timing > should record execution duration [44.90ms]
(pass) Memory Tools > memorySaveTool > error handling > should handle empty key gracefully [0.18ms]
(pass) Memory Tools > memorySaveTool > error handling > should handle empty value gracefully [0.05ms]
(pass) Memory Tools > memoryRecallTool > tool metadata > should have correct name
(pass) Memory Tools > memoryRecallTool > tool metadata > should have description
(pass) Memory Tools > memoryRecallTool > tool metadata > should have valid parameters schema
(pass) Memory Tools > memoryRecallTool > tool metadata > should define memory type enum values
(pass) Memory Tools > memoryRecallTool > execute > should recall short-term memory [40.96ms]
(pass) Memory Tools > memoryRecallTool > execute > should recall long-term memory [47.19ms]
(pass) Memory Tools > memoryRecallTool > execute > should recall both short-term and long-term memory [80.58ms]
(pass) Memory Tools > memoryRecallTool > execute > should filter by key when provided [49.98ms]
(pass) Memory Tools > memoryRecallTool > execute > should filter by category when provided [47.44ms]
(pass) Memory Tools > memoryRecallTool > execution timing > should record execution duration [38.93ms]
(pass) Memory Tools > memorySearchTool > tool metadata > should have correct name [0.14ms]
(pass) Memory Tools > memorySearchTool > tool metadata > should have description [0.04ms]
(pass) Memory Tools > memorySearchTool > tool metadata > should have valid parameters schema [0.05ms]
(pass) Memory Tools > memorySearchTool > execute > should search memory with basic query [46.16ms]
(pass) Memory Tools > memorySearchTool > execute > should search with category filter [47.44ms]
(pass) Memory Tools > memorySearchTool > execute > should respect limit parameter [62.53ms]
(pass) Memory Tools > memorySearchTool > execute > should handle empty query gracefully [0.14ms]
(pass) Memory Tools > memorySearchTool > execute > should use default limit of 5 when not specified [41.32ms]
(pass) Memory Tools > memorySearchTool > execution timing > should record execution duration [41.18ms]
(pass) Memory Tools > integration scenarios > should allow save followed by recall [94.31ms]
(pass) Memory Tools > integration scenarios > should allow search after saving [80.34ms]

packages/cloudflare-agent/src/agentic-loop/tools/__tests__/approval.test.ts:
(pass) Approval Tool > tool definition > should have correct name
(pass) Approval Tool > tool definition > should have descriptive description [0.16ms]
(pass) Approval Tool > tool definition > should define required parameters [0.02ms]
(pass) Approval Tool > tool definition > should define risk_level enum
(pass) Approval Tool > execute - successful approval requests > should request approval for valid action and reason [0.30ms]
(pass) Approval Tool > execute - successful approval requests > should include risk level in output [0.28ms]
(pass) Approval Tool > execute - successful approval requests > should default to medium risk level when not specified [0.14ms]
(pass) Approval Tool > execute - successful approval requests > should show low risk level [0.11ms]
(pass) Approval Tool > execute - successful approval requests > should show medium risk level [0.11ms]
(pass) Approval Tool > execute - successful approval requests > should show high risk level [0.02ms]
(pass) Approval Tool > execute - successful approval requests > should return awaiting_approval status [0.08ms]
(pass) Approval Tool > execute - successful approval requests > should include approval request ID [0.08ms]
(pass) Approval Tool > execute - successful approval requests > should include full approval request in data
(pass) Approval Tool > execute - successful approval requests > should include approval prompt in output
(pass) Approval Tool > execute - validation errors > should reject empty action
(pass) Approval Tool > execute - validation errors > should reject missing action
(pass) Approval Tool > execute - validation errors > should reject whitespace-only action [0.20ms]
(pass) Approval Tool > execute - validation errors > should reject empty reason
(pass) Approval Tool > execute - validation errors > should reject missing reason
(pass) Approval Tool > execute - validation errors > should reject invalid risk level [0.10ms]
(pass) Approval Tool > execute - validation errors > should handle undefined action gracefully
(pass) Approval Tool > execute - validation errors > should handle undefined reason gracefully
(pass) Approval Tool > execute - timing > should measure execution duration [0.12ms]
(pass) Approval Tool > execute - timing > should have reasonable duration for valid request
(pass) Approval Tool > createApprovalRequest helper > should create approval request with defaults
(pass) Approval Tool > createApprovalRequest helper > should create approval request with custom risk level
(pass) Approval Tool > createApprovalRequest helper > should generate unique request IDs [0.10ms]
(pass) Approval Tool > createApprovalRequest helper > should include current timestamp
(pass) Approval Tool > createApprovalRequest helper > should support all risk levels [0.03ms]
(pass) Approval Tool > formatApprovalResult helper > should format approved result
(pass) Approval Tool > formatApprovalResult helper > should format rejected result
(pass) Approval Tool > formatApprovalResult helper > should handle long action descriptions [0.10ms]
(pass) Approval Tool > formatApprovalResult helper > should handle special characters in action
(pass) Approval Tool > integration - realistic scenarios > should handle force push scenario [0.16ms]
(pass) Approval Tool > integration - realistic scenarios > should handle deletion scenario [0.06ms]
(pass) Approval Tool > integration - realistic scenarios > should handle backup scenario [0.04ms]
(pass) Approval Tool > integration - realistic scenarios > should format multi-line output properly [0.03ms]
(pass) Approval Tool > edge cases > should handle very long action descriptions
(pass) Approval Tool > edge cases > should handle Unicode in action
(pass) Approval Tool > edge cases > should handle newlines in reason [0.01ms]
(pass) Approval Tool > edge cases > should handle null risk_level gracefully
(pass) Approval Tool > edge cases > should reject malformed risk_level types [0.06ms]

packages/cloudflare-agent/src/agentic-loop/workflow/__tests__/types.test.ts:
(pass) serializeTools > should strip execute functions from tools [0.68ms]
(pass) serializeTools > should handle empty tool array
(pass) serializeTools > should handle multiple tools
(pass) isToolResultMessage > should return true for tool_result messages [0.12ms]
(pass) isToolResultMessage > should return false for user messages [0.02ms]
(pass) isToolResultMessage > should return false for assistant messages
(pass) isAssistantMessage > should return true for assistant messages [0.02ms]
(pass) isAssistantMessage > should return false for user messages
(pass) isAssistantMessage > should return false for tool_result messages
(pass) Type Structures > AgenticLoopWorkflowParams > should accept valid params structure
(pass) Type Structures > AgenticLoopWorkflowParams > should support optional fields [0.07ms]
(pass) Type Structures > WorkflowProgressUpdate > should accept thinking progress
(pass) Type Structures > WorkflowProgressUpdate > should accept tool_start progress with toolName [0.04ms]
(pass) Type Structures > WorkflowProgressUpdate > should accept tool_complete progress with duration [0.02ms]
(pass) Type Structures > WorkflowCompletionResult > should accept successful completion
(pass) Type Structures > WorkflowCompletionResult > should accept failed completion with error
(pass) Type Structures > WorkflowCompletionResult > should include debug context when available
(pass) Type Structures > SerializedTool > should have required fields
(pass) Type Structures > ProgressCallbackConfig > should contain DO reference information [0.09ms]
(pass) JsonRecord > should allow primitive values
(pass) JsonRecord > should allow nested objects
(pass) JsonRecord > should allow arrays

6 tests failed:

 956 pass
 6 fail
 6 errors
 2122 expect() calls
Ran 962 tests across 44 files. [3.42s]
