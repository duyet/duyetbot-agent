name: Claude Agent SDK

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'Task description for the agent'
        required: true
        type: string
      model:
        description: 'AI model to use'
        required: false
        default: 'anthropic/claude-sonnet-4-20250514'
        type: choice
        options:
          - anthropic/claude-sonnet-4-20250514
          - anthropic/claude-opus-4-20250514
          - anthropic/claude-haiku-4-20250514
          - google/gemini-2.5-flash
          - google/gemini-2.5-pro
          - openai/gpt-4o
          - openai/gpt-4o-mini
      agent_type:
        description: 'Agent type/preset'
        required: false
        default: 'default'
        type: choice
        options:
          - default
          - planner
          - researcher
          - coder
          - reviewer
      max_turns:
        description: 'Maximum conversation turns'
        required: false
        default: '100'
        type: string
      timeout:
        description: 'Timeout in minutes'
        required: false
        default: '30'
        type: string
      dry_run:
        description: 'Dry run (no git changes)'
        required: false
        default: false
        type: boolean
      create_pr:
        description: 'Create PR with changes'
        required: false
        default: true
        type: boolean
      pr_base:
        description: 'PR base branch'
        required: false
        default: 'master'
        type: string
      tools:
        description: 'Enable tools (bash, git, github, research)'
        required: false
        default: 'bash,git,github,research'
        type: string

concurrency:
  group: claude-agent-sdk-${{ github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  run-claude-agent:
    name: Run Claude Agent SDK
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    timeout-minutes: ${{ inputs.timeout || 30 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: ./.github/actions/setup-bun

      - name: Configure Git
        run: |
          git config user.name "duyetbot"
          git config user.email "duyetbot@users.noreply.github.com"

      - name: Build Project
        run: bun run build

      - name: Run Claude Agent SDK
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MODEL: ${{ inputs.model }}
          AGENT_TYPE: ${{ inputs.agent_type }}
          MAX_TURNS: ${{ inputs.max_turns }}
          TASK: ${{ inputs.task }}
          TOOLS: ${{ inputs.tools }}
          DRY_RUN: ${{ inputs.dry_run == 'true' && 'true' || 'false' }}
        run: |
          # Build agent command with safe environment variables
          CMD="bun run --cwd ./apps/github-actions-agent src/index.ts"

          # Use environment variables to avoid command injection
          sh -c 'CMD="$CMD --task \"$TASK\" --model \"$MODEL\" --agent-type \"$AGENT_TYPE\" --max-turns $MAX_TURNS --tools $TOOLS"
          if [ "$DRY_RUN" = "true" ]; then
            CMD="$CMD --dry-run"
          fi
          echo "Running Claude Agent SDK..."
          eval "$CMD"'

      - name: Create PR (if requested)
        if: inputs.create_pr == 'true' && inputs.dry_run != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BASE: ${{ inputs.pr_base }}
          TASK: ${{ inputs.task }}
          MODEL: ${{ inputs.model }}
          AGENT_TYPE: ${{ inputs.agent_type }}
          MAX_TURNS: ${{ inputs.max_turns }}
          TOOLS: ${{ inputs.tools }}
        run: |
          # Check if there are changes to commit
          if [ -n "$(git status --porcelain)" ]; then
            BRANCH_NAME="claude-agent-sdk-${{ github.run_number }}-$(date +%s)"
            git checkout -b "$BRANCH_NAME"
            git add -A

            # Use heredoc for multi-line commit message (safe)
            git commit -m "$(cat <<EOF
          feat: Claude Agent SDK task completion

          Task: ${TASK}
          Model: ${MODEL}
          Agent Type: ${AGENT_TYPE}

          ðŸ¤– Generated with [Claude Agent SDK](https://docs.anthropic.com/en/docs/agents-and-tools/claude-code/sdk)

          Co-Authored-By: duyetbot <duyetbot@users.noreply.github.com>
          EOF
          )"
            git push -u origin "$BRANCH_NAME"

            # Create PR with safe quoting
            gh pr create \
              --base "$PR_BASE" \
              --title "feat: Claude Agent SDK - ${TASK}" \
              --body "$(cat <<EOF
          ## Summary
          Automated task completion by Claude Agent SDK.

          ## Configuration
          - **Task**: ${TASK}
          - **Model**: ${MODEL}
          - **Agent Type**: ${AGENT_TYPE}
          - **Max Turns**: ${MAX_TURNS}
          - **Tools**: ${TOOLS}

          ðŸ¤– Generated with [Claude Agent SDK](https://docs.anthropic.com/en/docs/agents-and-tools/claude-code/sdk)

          Co-Authored-By: duyetbot <duyetbot@users.noreply.github.com>
          EOF
          )"
          else
            echo "No changes to commit"
          fi

      - name: Upload Agent Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: claude-agent-logs-${{ github.run_number }}
          path: |
            .agent/logs/
            .agent/state/
          retention-days: 30
          if-no-files-found: ignore

      - name: Summary
        if: always()
        env:
          TASK: ${{ inputs.task }}
          MODEL: ${{ inputs.model }}
          AGENT_TYPE: ${{ inputs.agent_type }}
          MAX_TURNS: ${{ inputs.max_turns }}
          TOOLS: ${{ inputs.tools }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          # Use environment variables for summary (safe)
          {
            echo "## Claude Agent SDK Run Summary"
            echo ""
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Task | ${TASK} |"
            echo "| Model | ${MODEL} |"
            echo "| Agent Type | ${AGENT_TYPE} |"
            echo "| Max Turns | ${MAX_TURNS} |"
            echo "| Tools | ${TOOLS} |"
            echo "| Dry Run | ${DRY_RUN} |"
            echo "| Status | ${{ job.status }} |"
          } >> "$GITHUB_STEP_SUMMARY"
