name: duyetbot-action Nightly

on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (no real changes)'
        required: false
        default: false
        type: boolean

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

# Define the prompt here in YAML for easy modification
vars:
  TASK_PROMPT: |
    Analyze the repository comprehensively and find things that need improvement.

    Priority order:
    1. Fix any bugs or issues found in existing code
    2. Implement features requested in GitHub issues
    3. Improve code quality, test coverage, or documentation
    4. Add new capabilities that would be valuable

    Process:
    1. Explore the codebase to understand its structure and purpose
    2. Identify specific improvements to make (be concrete and actionable)
    3. Plan the implementation in detail
    4. Implement the changes
    5. Create a pull request with clear description

    Be thorough and create production-ready code with proper tests.

jobs:
  run-agent:
    name: Run duyetbot-action Nightly
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    timeout-minutes: 120
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: ./.github/actions/setup-bun

      - name: Configure Git
        run: |
          git config user.name "duyetbot"
          git config user.email "duyetbot@users.noreply.github.com"

      - name: Build Project
        run: bun run build

      - name: Create GitHub Issue for Nightly Task
        id: create_issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use jq to safely construct the issue body
          ISSUE_BODY=$(jq -n \
            --arg desc "${{ vars.TASK_PROMPT }}" \
            '"## Task Description\n\n\($desc)\n\n---\n\n*This issue was automatically created by duyetbot-action Nightly*"')

          # Create GitHub issue
          RESPONSE=$(gh issue create \
            --title "ðŸŒ™ duyetbot-action Nightly: Repository Analysis" \
            --body "$ISSUE_BODY" \
            --label "duyetbot-action,scheduled" \
            --json number,title \
            --jq '{number: .number, title: .title}')

          ISSUE_NUMBER=$(echo "$RESPONSE" | jq -r '.number')
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "âœ… Created nightly issue #${ISSUE_NUMBER}"

      - name: Run duyetbot-action
        env:
          # OpenRouter with Anthropic-compatible API
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
          ANTHROPIC_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ANTHROPIC_DEFAULT_SONNET_MODEL: '@preset/claude-code-github-action'
          ANTHROPIC_DEFAULT_OPUS_MODEL: '@preset/claude-code-github-action'
          ANTHROPIC_DEFAULT_HAIKU_MODEL: '@preset/claude-code-github-action'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MEMORY_MCP_URL: ${{ secrets.MEMORY_MCP_URL }}
          DRY_RUN: ${{ inputs.dry_run == 'true' && 'true' || 'false' }}
        run: |
          TASK_ID="github-${{ steps.create_issue.outputs.issue_number }}"
          bun run apps/duyetbot-action/src/index.ts --source github-issues --task "$TASK_ID"

      - name: Close Nightly Issue
        if: inputs.dry_run != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.create_issue.outputs.issue_number }}
        run: |
          gh issue close "$ISSUE_NUMBER" \
            --comment "âœ… Completed by duyetbot-action Nightly run #${{ github.run_number }}"

      - name: Upload Agent Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: agent-logs-nightly-${{ github.run_number }}
          path: |
            .agent/logs/
            .agent/checkpoints/
          retention-days: 7
          if-no-files-found: ignore
