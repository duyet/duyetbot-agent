name: duyetbot-action Nightly

on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (no real changes)'
        required: false
        default: false
        type: boolean

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

# Define the prompt here in YAML for easy modification
# This agent will: analyze repo, find improvements, implement, create PR
vars:
  TASK_PROMPT: |
    Analyze the repository comprehensively and find things that need improvement.

    Priority order:
    1. Fix any bugs or issues found in existing code
    2. Implement features requested in GitHub issues
    3. Improve code quality, test coverage, or documentation
    4. Add new capabilities that would be valuable

    Process:
    1. Explore the codebase to understand its structure and purpose
    2. Identify specific improvements to make (be concrete and actionable)
    3. Plan the implementation in detail
    4. Implement the changes
    5. Create a pull request with clear description

    Be thorough and create production-ready code with proper tests.

jobs:
  run-agent:
    name: Run duyetbot-action Nightly
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    timeout-minutes: 120
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: ./.github/actions/setup-bun

      - name: Configure Git
        run: |
          git config user.name "duyetbot"
          git config user.email "duyetbot@users.noreply.github.com"

      - name: Build Project
        run: bun run build

      - name: Run duyetbot-action Nightly
        env:
          # OpenRouter with Anthropic-compatible API
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
          ANTHROPIC_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ANTHROPIC_DEFAULT_SONNET_MODEL: '@preset/claude-code-github-action'
          ANTHROPIC_DEFAULT_OPUS_MODEL: '@preset/claude-code-github-action'
          ANTHROPIC_DEFAULT_HAIKU_MODEL: '@preset/claude-code-github-action'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MEMORY_MCP_URL: ${{ secrets.MEMORY_MCP_URL }}
          TASK_DESCRIPTION: ${{ vars.TASK_PROMPT }}
          DRY_RUN: ${{ inputs.dry_run == 'true' && 'true' || 'false' }}
        run: |
          bun run apps/duyetbot-action/src/run-nightly.ts

      - name: Upload Agent Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: agent-logs-nightly-${{ github.run_number }}
          path: |
            .agent/logs/
            .agent/checkpoints/
          retention-days: 7
          if-no-files-found: ignore
