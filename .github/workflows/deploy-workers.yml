name: Deploy Cloudflare Workers

on:
  workflow_dispatch:
    inputs:
      app:
        description: 'App to deploy (all, github-bot, telegram-bot, dashboard, web, memory-mcp)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - github-bot
          - telegram-bot
          - dashboard
          - web
          - memory-mcp
  push:
    branches: [master]
    paths:
      - 'apps/github-bot/**'
      - 'apps/telegram-bot/**'
      - 'apps/dashboard/**'
      - 'apps/web/**'
      - 'apps/memory-mcp/**'
      - 'packages/**'
      - '.github/workflows/deploy-workers.yml'

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  deploy:
    name: Deploy Workers
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app:
          - github-bot
          - telegram-bot
          - memory-mcp
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: ./.github/actions/setup-bun

      - name: Build ${{ matrix.app }} dependencies
        run: |
          for pkg in packages/*/; do
            if [ -f "$pkg/package.json" ] && [ -f "$pkg/tsconfig.json" ]; then
              echo "Building $pkg..."
              (cd "$pkg" && npx tsc) || true
            fi
          done

      - name: Deploy ${{ matrix.app }}
        run: cd apps/${{ matrix.app }} && pnpm run deploy

  deploy-dashboard:
    name: Deploy Dashboard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: ./.github/actions/setup-bun

      - name: Build dashboard dependencies
        run: |
          for pkg in packages/analytics packages/*/; do
            if [ -f "$pkg/package.json" ] && [ -f "$pkg/tsconfig.json" ]; then
              echo "Building $pkg..."
              (cd "$pkg" && npx tsc) || true
            fi
          done

      - name: Build dashboard
        run: cd apps/dashboard && pnpm run build

      - name: Deploy Dashboard
        run: cd apps/dashboard && pnpm run deploy

  deploy-web:
    name: Deploy Web
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: ./.github/actions/setup-bun

      - name: Build web dependencies
        run: |
          for pkg in packages/*/; do
            if [ -f "$pkg/package.json" ] && [ -f "$pkg/tsconfig.json" ]; then
              echo "Building $pkg..."
              (cd "$pkg" && npx tsc) || true
            fi
          done

      - name: Build web
        run: cd apps/web && pnpm run build

      - name: Deploy Web
        run: cd apps/web && pnpm run deploy
