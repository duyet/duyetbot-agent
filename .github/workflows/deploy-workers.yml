name: Deploy Cloudflare Workers

on:
  workflow_dispatch:
    inputs:
      app:
        description: 'App to deploy (all, github-bot, telegram-bot, dashboard, web, memory-mcp)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - github-bot
          - telegram-bot
          - dashboard
          - web
          - memory-mcp
  push:
    branches: [master]
    paths:
      - 'apps/github-bot/**'
      - 'apps/telegram-bot/**'
      - 'apps/dashboard/**'
      - 'apps/web/**'
      - 'apps/memory-mcp/**'
      - 'packages/**'
      - '.github/workflows/deploy-workers.yml'

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  deploy:
    name: Deploy Workers
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app:
          - github-bot
          - telegram-bot
          - memory-mcp
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: ./.github/actions/setup-bun

      - name: Build dependencies
        run: npx turbo run build --filter=@duyetbot/${{ matrix.app }}...

      - name: Deploy ${{ matrix.app }}
        run: cd apps/${{ matrix.app }} && bun run deploy

  deploy-dashboard:
    name: Deploy Dashboard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: ./.github/actions/setup-bun

      - name: Build dashboard
        run: cd apps/dashboard && bun run build

      - name: Deploy Dashboard
        run: cd apps/dashboard && bun run deploy

  deploy-web:
    name: Deploy Web
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: ./.github/actions/setup-bun

      - name: Build web
        run: cd apps/web && bun run build

      - name: Deploy Web
        run: cd apps/web && bun run deploy
