name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  # Fast quality checks run in parallel via Turbo
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: ./.github/actions/setup-bun

      - name: Run all quality checks
        run: |
          bun run lint &
          bun run type-check &
          wait

  # Unit tests with coverage
  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: ./.github/actions/setup-bun

      - name: Run tests with coverage
        run: bun run test -- -- --coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false

  # Build all packages (uses Turbo cache)
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [quality, test]
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: ./.github/actions/setup-bun

      - name: Build all packages
        run: bun run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            packages/*/dist
            apps/*/dist
          retention-days: 1

  # Integration tests (run after build, share Turbo cache)
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: ./.github/actions/setup-bun
        with:
          build: 'true'

      - name: Run integration tests
        run: bun run --filter @duyetbot/integration-tests test

  # E2E tests
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: ./.github/actions/setup-bun
        with:
          build: 'true'

      - name: Run E2E tests
        run: |
          bun run --filter @duyetbot/e2e-tests test
          bun run --filter @duyetbot/telegram-bot test:e2e
