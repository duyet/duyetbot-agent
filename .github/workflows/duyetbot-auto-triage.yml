# Automatically triage new issues and assign to duyetbot agent
name: duyetbot Auto Triage

on:
  issues:
    types: [opened]

permissions:
  contents: read
  issues: write

concurrency:
  group: auto-triage-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  auto-triage:
    name: Auto-triage new issue
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Assign to duyetbot and label
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"

          echo "üè∑Ô∏è Auto-triaging issue #${ISSUE_NUMBER}"

          # Add triage label (safe - issue_number is numeric)
          gh issue label "$ISSUE_NUMBER" --add-label "triage,new-issue"

          # Assign to duyetbot (safe - username is hardcoded)
          gh issue edit "$ISSUE_NUMBER" --assignee duyetbot

          echo "‚úÖ Issue assigned to @duyetbot with labels: triage, new-issue"

  trigger-agent:
    name: Trigger duyetbot-action
    runs-on: ubuntu-latest
    needs: auto-triage
    permissions:
      contents: write
      pull-requests: write
      issues: write
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: ./.github/actions/setup-bun

      - name: Configure Git
        run: |
          git config user.name "duyetbot"
          git config user.email "duyetbot@users.noreply.github.com"

      - name: Build
        run: bun run build

      - name: Run agent on new issue
        env:
          # Safe: using environment variables for GitHub context
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPOSITORY: ${{ github.repository }}
          # Agent configuration
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ANTHROPIC_DEFAULT_SONNET_MODEL: '@preset/claude-code-github-action'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MEMORY_MCP_URL: ${{ secrets.MEMORY_MCP_URL }}
          DRY_RUN: "false"
        run: |
          echo "ü§ñ Analyzing issue #${ISSUE_NUMBER} with duyetbot-action..."
          echo "Repository: ${REPOSITORY}"

          # Run agent to process the issue
          # Safe: ISSUE_NUMBER is validated numeric, REPOSITORY from context
          bun run apps/duyetbot-action/src/index.ts \
            --source="github-issues" \
            --task="github-${REPOSITORY}-${ISSUE_NUMBER}"

      - name: Update issue status
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          JOB_STATUS: ${{ job.status }}
        run: |
          # Safe: ISSUE_NUMBER is numeric, JOB_STATUS is enum
          if [ "$JOB_STATUS" = "success" ]; then
            gh issue label "$ISSUE_NUMBER" --add-label "agent-completed"
            gh issue label "$ISSUE_NUMBER" --remove-label "triage" || true
          else
            gh issue label "$ISSUE_NUMBER" --add-label "agent-failed"
            gh issue comment "$ISSUE_NUMBER" --body "‚ö†Ô∏è Agent processing failed. Check workflow logs for details."
          fi
