name = "duyetbot-shared-agents"
main = "src/index.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]

[ai]
binding = "AI"

[vars]
MODEL = "@preset/duyetbot"
AI_GATEWAY_NAME = "duyetbot"

[observability]
enabled = true

[observability.logs]
enabled = true
invocation_logs = true
head_sampling_rate = 1

[observability.traces]
enabled = true
head_sampling_rate = 1

[placement]
mode = "smart"

# Shared Durable Objects - exported for cross-script access
[[durable_objects.bindings]]
name = "RouterAgent"
class_name = "RouterAgent"

[[durable_objects.bindings]]
name = "SimpleAgent"
class_name = "SimpleAgent"

[[durable_objects.bindings]]
name = "HITLAgent"
class_name = "HITLAgent"

[[durable_objects.bindings]]
name = "OrchestratorAgent"
class_name = "OrchestratorAgent"

[[durable_objects.bindings]]
name = "CodeWorker"
class_name = "CodeWorker"

[[durable_objects.bindings]]
name = "ResearchWorker"
class_name = "ResearchWorker"

[[durable_objects.bindings]]
name = "GitHubWorker"
class_name = "GitHubWorker"

[[durable_objects.bindings]]
name = "DuyetInfoAgent"
class_name = "DuyetInfoAgent"

[[durable_objects.bindings]]
name = "GitHubMCPAgent"
class_name = "GitHubMCPAgent"

# State Management DO for observability and watchdog recovery
[[durable_objects.bindings]]
name = "StateDO"
class_name = "StateDO"

# Agentic Scheduler DO for task scheduling with energy budget
[[durable_objects.bindings]]
name = "SchedulerObject"
class_name = "SchedulerObject"

# Migrations for SQLite state persistence
[[migrations]]
tag = "v1"
new_sqlite_classes = ["RouterAgent", "SimpleAgent", "HITLAgent", "OrchestratorAgent", "CodeWorker", "ResearchWorker", "GitHubWorker", "DuyetInfoAgent"]

# Migration for StateDO (new in v2)
[[migrations]]
tag = "v2"
new_sqlite_classes = ["StateDO"]

# Migration for SchedulerObject (new in v3)
[[migrations]]
tag = "v3"
new_sqlite_classes = ["SchedulerObject"]

# Migration for GitHubMCPAgent (new in v4)
[[migrations]]
tag = "v4"
new_sqlite_classes = ["GitHubMCPAgent"]

# D1 Database for observability events
# Schema owner: shared-agents (migrations in ./migrations/)
# Used by: telegram-bot, github-bot (via cross-binding)
[[d1_databases]]
binding = "OBSERVABILITY_DB"
database_name = "duyetbot"
database_id = "6d29934e-92cc-48ff-9149-8ddf6846fd43"
migrations_dir = "migrations"

# KV namespace for safety kernel heartbeat
# This is shared with duyetbot-safety-kernel for dead man's switch
[[kv_namespaces]]
binding = "HEARTBEAT_KV"
id = "f86303f7fa3a45dd986c0c6bf835c8e1"

# =============================================================================
# Workflows (Durable Execution)
# =============================================================================

# AgenticLoopWorkflow - Timeout-resistant agent execution
# Runs the agentic loop as durable workflow steps, eliminating 30s DO timeout
[[workflows]]
name = "agentic-loop-workflow"
binding = "AGENTIC_LOOP_WORKFLOW"
class_name = "AgenticLoopWorkflow"
